# Edge Functions 401 éŒ¯èª¤ - å®Œæ•´è§£æ±ºæ–¹æ¡ˆ

> **å»ºç«‹æ—¥æœŸ**ï¼š2025-01-29  
> **éŒ¯èª¤**ï¼š`{"code":401,"message":"ç¼ºå°‘æˆæ¬Šæ¨™é ­"}`  
> **å½±éŸ¿ç¯„åœ**ï¼šLINE å’Œ Twitter ç™»å…¥éƒ½å¤±æ•—

---

## ğŸ” å•é¡Œåˆ†æ

### éŒ¯èª¤è¨Šæ¯

```
https://epyykzxxglkjombvozhr.supabase.co/functions/v1/line-auth/callback?code=...&state=...
{"code":401,"message":"ç¼ºå°‘æˆæ¬Šæ¨™é ­"}
```

### å•é¡Œæ ¹æº

**Supabase åœ¨è·¯ç”±å±¤ç´šè¦æ±‚æˆæ¬Šæ¨™é ­**ï¼Œä½† OAuth å›èª¿è«‹æ±‚ä¾†è‡ªå¤–éƒ¨æœå‹™å™¨ï¼ˆLINE å’Œ Xï¼‰ï¼Œä¸æœƒåŒ…å« Supabase çš„ JWTã€‚

**é€™æ˜¯ä¸€å€‹ Supabase Edge Functions çš„é…ç½®å•é¡Œ**ï¼Œéœ€è¦åœ¨ Supabase Dashboard ä¸­æ­£ç¢ºè¨­ç½®ã€‚

---

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç¢ºèª "Verify JWT with legacy secret" è¨­å®šï¼ˆæœ€é‡è¦ï¼‰

**è©³ç´°æ­¥é©Ÿ**ï¼š

1. **ç™»å…¥ [Supabase Dashboard](https://app.supabase.com/)**

2. **é€²å…¥ Edge Functions**ï¼š
   - å·¦å´é¸å–® â†’ **Edge Functions**

3. **æª¢æŸ¥ `line-auth` å‡½æ•¸**ï¼š
   - åœ¨å‡½æ•¸åˆ—è¡¨ä¸­ï¼Œæ‰¾åˆ° `line-auth`
   - **é»æ“Šå‡½æ•¸åç¨±**é€²å…¥è©³ç´°é é¢
   - æ‰¾åˆ° **ã€ŒVerify JWT with legacy secretã€** é¸é …
   - **ç¢ºèªæ˜¯å¦çœŸçš„å•Ÿç”¨**ï¼ˆå‹¾é¸ï¼‰
   - å¦‚æœæ²’æœ‰å•Ÿç”¨ï¼Œ**å•Ÿç”¨å®ƒ**
   - é»æ“Š **ã€ŒSaveã€** æˆ– **ã€ŒUpdateã€**

4. **æª¢æŸ¥ `twitter-auth` å‡½æ•¸**ï¼š
   - åœ¨å‡½æ•¸åˆ—è¡¨ä¸­ï¼Œæ‰¾åˆ° `twitter-auth`
   - **é»æ“Šå‡½æ•¸åç¨±**é€²å…¥è©³ç´°é é¢
   - æ‰¾åˆ° **ã€ŒVerify JWT with legacy secretã€** é¸é …
   - **å•Ÿç”¨å®ƒ**ï¼ˆèˆ‡ LINE ç›¸åŒï¼‰
   - é»æ“Š **ã€ŒSaveã€** æˆ– **ã€ŒUpdateã€**

5. **ç­‰å¾… 30-60 ç§’**è®“è¨­å®šç”Ÿæ•ˆ

---

### æ–¹æ¡ˆ 2ï¼šæª¢æŸ¥ Supabase å°ˆæ¡ˆçš„å…¨åŸŸè¨­å®š

**æª¢æŸ¥ Edge Functions çš„å…¨åŸŸè¨­å®š**ï¼š

1. **é€²å…¥ Settings â†’ Edge Functions**

2. **æª¢æŸ¥å…¨åŸŸè¨­å®š**ï¼š
   - æŸ¥çœ‹æ˜¯å¦æœ‰ **ã€ŒRequire JWT for all functionsã€** çš„é¸é …
   - å¦‚æœæœ‰ï¼Œç¢ºèªæ˜¯å¦å•Ÿç”¨
   - å¦‚æœå•Ÿç”¨ï¼Œ**é—œé–‰**å®ƒï¼ˆæˆ–ç‚ºç‰¹å®šå‡½æ•¸è¨­ç½®ä¾‹å¤–ï¼‰

---

### æ–¹æ¡ˆ 3ï¼šé‡æ–°éƒ¨ç½² Edge Functions

**å¦‚æœè¨­å®šéƒ½æ­£ç¢ºï¼Œå˜—è©¦é‡æ–°éƒ¨ç½²**ï¼š

```bash
cd votechaos-main
npx supabase functions deploy line-auth
npx supabase functions deploy twitter-auth
```

---

### æ–¹æ¡ˆ 4ï¼šæª¢æŸ¥ Edge Function æ—¥èªŒ

**æŸ¥çœ‹è©³ç´°éŒ¯èª¤è³‡è¨Š**ï¼š

1. **é€²å…¥ Edge Functions â†’ line-auth â†’ Logs**
2. **æŸ¥çœ‹æœ€è¿‘çš„è«‹æ±‚æ—¥èªŒ**ï¼š
   - æ‰¾åˆ°è¿”å› 401 éŒ¯èª¤çš„è«‹æ±‚
   - æŸ¥çœ‹å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯
   - æŸ¥çœ‹è«‹æ±‚è©³æƒ…ï¼ˆheadersã€methodã€path ç­‰ï¼‰

3. **é€²å…¥ Edge Functions â†’ twitter-auth â†’ Logs**
4. **æŸ¥çœ‹æœ€è¿‘çš„è«‹æ±‚æ—¥èªŒ**ï¼š
   - æ‰¾åˆ°è¿”å› 401 éŒ¯èª¤çš„è«‹æ±‚
   - æŸ¥çœ‹å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯
   - æŸ¥çœ‹è«‹æ±‚è©³æƒ…ï¼ˆheadersã€methodã€path ç­‰ï¼‰

---

## ğŸ¯ å„ªå…ˆè¡Œå‹•

### ç«‹å³æª¢æŸ¥ï¼ˆæŒ‰é †åºï¼‰

1. **âœ… ç¢ºèª "Verify JWT with legacy secret" è¨­å®š**ï¼ˆæœ€é‡è¦ï¼‰
   - æª¢æŸ¥ `line-auth` å‡½æ•¸çš„è¨­å®š
   - æª¢æŸ¥ `twitter-auth` å‡½æ•¸çš„è¨­å®š
   - ç¢ºä¿å…©è€…éƒ½**å•Ÿç”¨**ï¼ˆå‹¾é¸ï¼‰

2. **âœ… ç­‰å¾… 30-60 ç§’**è®“è¨­å®šç”Ÿæ•ˆ

3. **âœ… é‡æ–°æ¸¬è©¦**ï¼š
   - å®Œå…¨é—œé–‰ä¸¦é‡æ–°é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼ï¼ˆæ¸…é™¤å¿«å–ï¼‰
   - æ¸¬è©¦ LINE ç™»å…¥
   - æ¸¬è©¦ Twitter ç™»å…¥

4. **âœ… å¦‚æœä»ç„¶å¤±æ•—**ï¼š
   - æª¢æŸ¥ Edge Function æ—¥èªŒ
   - æª¢æŸ¥ Supabase å°ˆæ¡ˆçš„å…¨åŸŸè¨­å®š
   - é‡æ–°éƒ¨ç½² Edge Functions

---

## ğŸ“ éœ€è¦ç¢ºèªçš„è³‡è¨Š

è«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š

1. **Edge Functions è¨­å®šæˆªåœ–**ï¼š
   - `line-auth` å‡½æ•¸çš„è¨­å®šé é¢æˆªåœ–
   - `twitter-auth` å‡½æ•¸çš„è¨­å®šé é¢æˆªåœ–
   - ç‰¹åˆ¥æ˜¯ **ã€ŒVerify JWT with legacy secretã€** é¸é …çš„ç‹€æ…‹

2. **Edge Function æ—¥èªŒ**ï¼š
   - `line-auth` å‡½æ•¸çš„æœ€è¿‘è«‹æ±‚æ—¥èªŒ
   - `twitter-auth` å‡½æ•¸çš„æœ€è¿‘è«‹æ±‚æ—¥èªŒ
   - å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯

3. **Supabase å°ˆæ¡ˆè¨­å®š**ï¼š
   - Settings â†’ Edge Functions çš„å…¨åŸŸè¨­å®šæˆªåœ–

---

## ğŸ”— ç›¸é—œæ–‡ä»¶

- [X ç™»å…¥-401éŒ¯èª¤-å•Ÿç”¨JWTé©—è­‰](./Xç™»å…¥-401éŒ¯èª¤-å•Ÿç”¨JWTé©—è­‰.md)
- [X ç™»å…¥-401éŒ¯èª¤æœ€çµ‚è§£æ±º](./Xç™»å…¥-401éŒ¯èª¤æœ€çµ‚è§£æ±º.md)

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-29



