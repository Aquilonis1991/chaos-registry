# Edge Functions 401 éŒ¯èª¤ - æª¢æŸ¥æ¸…å–®

> **å»ºç«‹æ—¥æœŸ**ï¼š2025-01-29  
> **ç‹€æ…‹**ï¼šå·²ç¢ºèª API è¨­å®šä¸­æ²’æœ‰ç›¸é—œé¸é …

---

## âœ… å·²å®Œæˆçš„æª¢æŸ¥

1. **API è¨­å®š**ï¼š
   - âœ… å·²æª¢æŸ¥ Settings â†’ API
   - âŒ æ²’æœ‰ "Require JWT for Edge Functions" é¸é …
   - âŒ åªæœ‰ API Keys è¨­å®š

2. **Edge Function è¨­å®š**ï¼š
   - âœ… å·²é—œé–‰ "Verify JWT with legacy secret"
   - â“ éœ€è¦æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–é¸é …

3. **ä»£ç¢¼ä¿®æ”¹**ï¼š
   - âœ… å·²å°‡ `serve` æ”¹ç‚º `Deno.serve`
   - âœ… å·²é‡æ–°éƒ¨ç½² Edge Functions

---

## ğŸ” éœ€è¦æª¢æŸ¥çš„é …ç›®

### 1. Edge Functions è¨­å®šé é¢

è«‹æª¢æŸ¥ Edge Functions çš„è¨­å®šé é¢ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹é¸é …ï¼š

1. **é€²å…¥ Edge Functions â†’ line-auth**
2. **é»æ“Šå‡½æ•¸åç¨±é€²å…¥è©³ç´°é é¢**
3. **æŸ¥çœ‹è¨­å®šé¸é …**ï¼š
   - [ ] **"Public Endpoint"** æˆ– **"Allow Public Access"**
   - [ ] **"Skip JWT Verification"** æˆ– **"Bypass JWT"**
   - [ ] **"Require Authentication"**ï¼ˆæ‡‰è©²é—œé–‰ï¼‰
   - [ ] å…¶ä»–ç›¸é—œé¸é …

4. **æˆªåœ–è¨­å®šé é¢**ï¼Œç‰¹åˆ¥æ˜¯ï¼š
   - æ‰€æœ‰å¯ç”¨çš„é¸é …
   - ç•¶å‰é¸é …çš„ç‹€æ…‹

---

### 2. Supabase å°ˆæ¡ˆè¨­å®š

è«‹æª¢æŸ¥ä»¥ä¸‹è¨­å®šï¼š

1. **Settings â†’ General**ï¼š
   - æŸ¥çœ‹æ˜¯å¦æœ‰èˆ‡ Edge Functions ç›¸é—œçš„è¨­å®š

2. **Settings â†’ Edge Functions**ï¼š
   - æŸ¥çœ‹æ˜¯å¦æœ‰å…¨åŸŸè¨­å®š
   - æŸ¥çœ‹æ˜¯å¦æœ‰ "Default JWT Verification" é¸é …

---

## ğŸ¯ å¦‚æœæ²’æœ‰æ‰¾åˆ°ç›¸é—œé¸é …

### å»ºè­°ï¼šè¯ç¹« Supabase æ”¯æŒ

**å¦‚æœ Edge Functions è¨­å®šé é¢æ²’æœ‰å…¶ä»–é¸é …ï¼Œå»ºè­°è¯ç¹« Supabase æ”¯æŒ**ï¼š

1. **é€²å…¥ [Supabase Support](https://supabase.com/support)**

2. **æä¾›ä»¥ä¸‹è³‡è¨Š**ï¼š

   **å•é¡Œæè¿°**ï¼š
   ```
   æˆ‘åœ¨ä½¿ç”¨ Supabase Edge Functions è™•ç† OAuth å›èª¿æ™‚é‡åˆ° 401 éŒ¯èª¤ã€‚
   
   å•é¡Œï¼š
   - OAuth å›èª¿è«‹æ±‚ä¾†è‡ªå¤–éƒ¨æœå‹™å™¨ï¼ˆLINE/Xï¼‰ï¼Œä¸æœƒåŒ…å« Supabase çš„ JWT
   - å³ä½¿é—œé–‰äº† "Verify JWT with legacy secret" é¸é …ï¼Œä»ç„¶è¿”å› 401 éŒ¯èª¤
   - éŒ¯èª¤è¨Šæ¯ï¼š{"code":401,"message":"ç¼ºå°‘æˆæ¬Šæ¨™é ­"}
   ```

   **å·²å˜—è©¦çš„è§£æ±ºæ–¹æ¡ˆ**ï¼š
   ```
   1. é—œé–‰ "Verify JWT with legacy secret" é¸é …
   2. ä½¿ç”¨ Deno.serve è€Œä¸æ˜¯ serve
   3. é‡æ–°éƒ¨ç½² Edge Functions
   4. æª¢æŸ¥ Settings â†’ APIï¼ˆæ²’æœ‰ç›¸é—œé¸é …ï¼‰
   5. æª¢æŸ¥ Settings â†’ Edge Functionsï¼ˆæ²’æœ‰å…¨åŸŸè¨­å®šï¼‰
   ```

   **è«‹æ±‚ URL**ï¼š
   ```
   https://epyykzxxglkjombvozhr.supabase.co/functions/v1/line-auth/callback?code=...&state=...
   ```

   **è©¢å•**ï¼š
   ```
   å¦‚ä½•å…è¨± OAuth å›èª¿è«‹æ±‚ï¼ˆæ²’æœ‰ JWTï¼‰è¨ªå• Edge Functionsï¼Ÿ
   æ˜¯å¦æœ‰å°ˆæ¡ˆç´šè¨­å®šéœ€è¦èª¿æ•´ï¼Ÿ
   æ˜¯å¦æœ‰å…¶ä»–æ–¹æ³•è™•ç† OAuth å›èª¿ï¼Ÿ
   ```

---

## ğŸ“ éœ€è¦æä¾›çš„è³‡è¨Š

è«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š

1. **Edge Functions è¨­å®šé é¢æˆªåœ–**ï¼š
   - `line-auth` å‡½æ•¸çš„å®Œæ•´è¨­å®šé é¢
   - æ‰€æœ‰å¯ç”¨çš„é¸é …å’Œç•¶å‰ç‹€æ…‹

2. **Settings â†’ Edge Functions æˆªåœ–**ï¼š
   - å¦‚æœæœ‰å…¨åŸŸè¨­å®šï¼Œè«‹æˆªåœ–

3. **Supabase ç‰ˆæœ¬è³‡è¨Š**ï¼š
   - å°ˆæ¡ˆçš„ Supabase ç‰ˆæœ¬
   - Edge Functions çš„é‹è¡Œæ™‚ç‰ˆæœ¬

---

## ğŸ”— ç›¸é—œæ–‡ä»¶

- [EdgeFunctions-401éŒ¯èª¤-æ›¿ä»£è§£æ±ºæ–¹æ¡ˆ](./EdgeFunctions-401éŒ¯èª¤-æ›¿ä»£è§£æ±ºæ–¹æ¡ˆ.md)
- [EdgeFunctions-401éŒ¯èª¤-æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ](./EdgeFunctions-401éŒ¯èª¤-æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ.md)

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-29


