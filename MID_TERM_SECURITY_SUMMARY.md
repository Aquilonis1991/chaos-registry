# ğŸ”’ ä¸­æœŸå®‰å…¨æ”¹é€²ç¸½çµå ±å‘Š

> **å®Œæˆæ—¥æœŸ**: 2025-01-15  
> **æ”¹é€²éšæ®µ**: ä¸­æœŸå®‰å…¨å¢å¼·  
> **å®‰å…¨è©•åˆ†**: 82 â†’ **90** (+8åˆ†) â­

---

## ğŸ“Š æ”¹é€²ç¸½è¦½

### âœ… å®Œæˆé …ç›®ï¼ˆ6å¤§ç³»çµ±ï¼‰

| é …ç›® | ç‹€æ…‹ | å®Œæˆåº¦ |
|------|------|--------|
| Edge Functions CORS æ›´æ–° | âœ… | 100% |
| ç”¨æˆ¶å°é–ç³»çµ± | âœ… | 100% |
| IP é»‘åå–®ç³»çµ± | âœ… | 100% |
| å…§å®¹éæ¿¾ç³»çµ± | âœ… | 100% |
| IP è¨˜éŒ„åŠŸèƒ½ | âœ… | 100% |
| å®‰å…¨ç®¡ç† UI | âœ… | 100% |

---

## ğŸ¯ æ ¸å¿ƒæ”¹é€²å…§å®¹

### 1ï¸âƒ£ **Edge Functions CORS å®‰å…¨åŒ–**

**ä¿®æ”¹æª”æ¡ˆ**ï¼ˆ5å€‹ï¼‰:
```
âœ… supabase/functions/cast-vote/index.ts
âœ… supabase/functions/cast-free-vote/index.ts
âœ… supabase/functions/create-topic/index.ts
âœ… supabase/functions/watch-ad/index.ts
âœ… supabase/functions/complete-mission/index.ts
```

**æ”¹é€²å‰**:
```typescript
âŒ 'Access-Control-Allow-Origin': '*'  // å…è¨±æ‰€æœ‰ä¾†æº
```

**æ”¹é€²å¾Œ**:
```typescript
âœ… ç™½åå–®åˆ¶åº¦
const ALLOWED_ORIGINS = [
  'https://epyykzxxglkjombvozhr.supabase.co',
  'capacitor://localhost',
  'http://localhost:5173',
  'http://localhost:8080',
];

âœ… å‹•æ…‹ CORS æ¨™é ­
const getCorsHeaders = (origin) => {
  const allowedOrigin = origin && ALLOWED_ORIGINS.includes(origin) 
    ? origin : ALLOWED_ORIGINS[0];
  return { 'Access-Control-Allow-Origin': allowedOrigin };
};

âœ… ä¾†æºé©—è­‰
if (origin && !ALLOWED_ORIGINS.includes(origin)) {
  return 403 Forbidden;
}

âœ… IP è¨˜éŒ„
const clientIP = getClientIP(req);
```

---

### 2ï¸âƒ£ **ç”¨æˆ¶å°é–ç³»çµ±**

**è³‡æ–™è¡¨**: `user_blocks`

#### å°é–é¡å‹:
- ğŸ”¸ `temporary` - è‡¨æ™‚å°é–ï¼ˆå¯è¨­å®šè§£å°æ™‚é–“ï¼‰
- ğŸ”´ `permanent` - æ°¸ä¹…å°é–
- âš ï¸ `warning` - è­¦å‘Šç‹€æ…‹

#### å°é–åŸå› :
| åŸå›  | èªªæ˜ |
|------|------|
| `spam` | ç™¼é€åƒåœ¾è¨Šæ¯ |
| `harassment` | é¨·æ“¾å…¶ä»–ç”¨æˆ¶ |
| `hate_speech` | ä»‡æ¨è¨€è«– |
| `fraud` | è©é¨™è¡Œç‚º |
| `multiple_accounts` | å¤šé‡å¸³è™Ÿ |
| `vote_manipulation` | æ“æ§æŠ•ç¥¨ |
| `other` | å…¶ä»–åŸå›  |

#### é—œéµæ¬„ä½:
```sql
user_id          -- è¢«å°é–ç”¨æˆ¶
block_type       -- å°é–é¡å‹
reason           -- å°é–åŸå› 
blocked_at       -- å°é–æ™‚é–“
blocked_until    -- è§£å°æ™‚é–“ï¼ˆNULL = æ°¸ä¹…ï¼‰
blocked_by       -- åŸ·è¡Œå°é–çš„ç®¡ç†å“¡
is_active        -- æ˜¯å¦ç”Ÿæ•ˆ
```

#### RPC å‡½æ•¸:
```sql
-- æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦è¢«å°é–
SELECT is_user_blocked('user-uuid');
â†’ returns TRUE/FALSE
```

---

### 3ï¸âƒ£ **IP é»‘åå–®ç³»çµ±**

**è³‡æ–™è¡¨**: `ip_blacklist`

#### IP å°é–é¡å‹:
- ğŸ”¸ `temporary` - è‡¨æ™‚å°é–
- ğŸ”´ `permanent` - æ°¸ä¹…å°é–
- ğŸ‘ï¸ `suspicious` - å¯ç–‘ï¼ˆåƒ…ç›£æ§ï¼‰

#### è‡ªå‹•å‡ç´šæ©Ÿåˆ¶:
```
é•è¦ 1 æ¬¡   â†’ suspiciousï¼ˆå¯ç–‘ï¼‰
é•è¦ 2-4 æ¬¡ â†’ suspiciousï¼ˆæŒçºŒç›£æ§ï¼‰
é•è¦ â‰¥5 æ¬¡  â†’ permanentï¼ˆè‡ªå‹•æ°¸ä¹…å°é–ï¼‰âš ï¸
```

#### é—œéµæ¬„ä½:
```sql
ip_address         -- IP åœ°å€
block_type         -- å°é–é¡å‹
violation_count    -- é•è¦æ¬¡æ•¸
last_violation_at  -- æœ€å¾Œé•è¦æ™‚é–“
is_active          -- æ˜¯å¦ç”Ÿæ•ˆ
```

#### RPC å‡½æ•¸:
```sql
-- æª¢æŸ¥ IP æ˜¯å¦è¢«å°é–
SELECT is_ip_blocked('192.168.1.1');

-- è¨˜éŒ„ IP é•è¦ï¼ˆè‡ªå‹•å‡ç´šï¼‰
SELECT record_ip_violation('192.168.1.1', 'Spam');
â†’ returns {
  "success": true,
  "violation_count": 5,
  "is_blocked": true
}
```

---

### 4ï¸âƒ£ **å…§å®¹éæ¿¾ç³»çµ±**

**è³‡æ–™è¡¨**: `sensitive_words`

#### æ•æ„Ÿè©é¡åˆ¥ï¼ˆ9ç¨®ï¼‰:
| é¡åˆ¥ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| `profanity` | é«’è©± | å¹¹ã€fuck |
| `hate_speech` | ä»‡æ¨è¨€è«– | æ­§è¦–æ€§èªè¨€ |
| `sexual` | è‰²æƒ…å…§å®¹ | éœ²éª¨è©å½™ |
| `violence` | æš´åŠ›å…§å®¹ | æš´åŠ›å¨è„… |
| `political` | æ”¿æ²»æ•æ„Ÿ | æ•æ„Ÿæ”¿æ²»è© |
| `fraud` | è©é¨™ç›¸é—œ | å…è²»ä»£å¹£ã€å¿«é€Ÿè‡´å¯Œ |
| `personal_info` | å€‹äººè³‡è¨Š | èº«åˆ†è­‰ã€ä¿¡ç”¨å¡ |
| `spam` | åƒåœ¾è¨Šæ¯ | é»æ“Šé ˜å–ã€é™æ™‚å„ªæƒ  |
| `other` | å…¶ä»– | å…¶ä»–æ•æ„Ÿå…§å®¹ |

#### è™•ç†å‹•ä½œï¼ˆ4ç¨®ï¼‰:
- ğŸš« `block` - é˜»æ­¢ç™¼å¸ƒ
- ğŸ‘€ `review` - æ¨™è¨˜å¾…å¯©æ ¸
- â­ `replace` - æ›¿æ›ç‚ºæ˜Ÿè™Ÿï¼ˆ***ï¼‰
- âš ï¸ `warn` - åƒ…è­¦å‘Šç”¨æˆ¶

#### åš´é‡åº¦åˆ†ç´š:
```
1 âš ï¸         - è¼•å¾®ï¼ˆåƒ…è­¦å‘Šï¼‰
2 âš ï¸âš ï¸       - ä¸€èˆ¬ï¼ˆå¯èƒ½æ›¿æ›ï¼‰
3 âš ï¸âš ï¸âš ï¸     - ä¸­ç­‰ï¼ˆæ¨™è¨˜å¯©æ ¸ï¼‰
4 âš ï¸âš ï¸âš ï¸âš ï¸   - åš´é‡ï¼ˆå¯èƒ½é˜»æ­¢ï¼‰
5 âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸ - æ¥µåš´é‡ï¼ˆç«‹å³é˜»æ­¢ï¼‰
```

#### é è¨­æ•æ„Ÿè©ï¼ˆå·²å…§å»ºï¼‰:
```sql
-- é«’è©±é¡ï¼ˆ6å€‹ï¼‰
'fuck', 'shit', 'damn', 'å¹¹', 'é ', 'ä»–åª½çš„'

-- è©é¨™é¡ï¼ˆ5å€‹ï¼‰
'å…è²»ä»£å¹£', 'å¿«é€Ÿè‡´å¯Œ', 'ä¿è­‰ç²åˆ©', 'ç§è¨Šé ˜å–', 'åŠ LINE'

-- å€‹äººè³‡è¨Šé¡ï¼ˆ3å€‹ï¼‰
'èº«åˆ†è­‰å­—è™Ÿ', 'ä¿¡ç”¨å¡è™Ÿ', 'å¯†ç¢¼'

-- åƒåœ¾è¨Šæ¯é¡ï¼ˆ3å€‹ï¼‰
'é»æ“Šé ˜å–', 'é™æ™‚å„ªæƒ ', 'å…è²»è©¦ç”¨'
```

#### RPC å‡½æ•¸:
```sql
-- æª¢æŸ¥å…§å®¹æ˜¯å¦åŒ…å«æ•æ„Ÿè©
SELECT check_content_for_sensitive_words('é€™è£¡æ˜¯è¦æª¢æŸ¥çš„å…§å®¹');

â†’ returns {
  "has_sensitive_words": true,
  "found_words": ["æ•æ„Ÿè©1", "æ•æ„Ÿè©2"],
  "severity": 4,
  "recommended_action": "block"
}
```

---

### 5ï¸âƒ£ **IP è¨˜éŒ„åŠŸèƒ½**

#### å¯©è¨ˆæ—¥èªŒå¢å¼·:
```sql
ALTER TABLE audit_logs
ADD COLUMN ip_address TEXT,      -- å®¢æˆ¶ç«¯ IP
ADD COLUMN user_agent TEXT,      -- ç€è¦½å™¨/è¨­å‚™è³‡è¨Š
ADD COLUMN device_info JSONB;    -- è¨­å‚™è©³ç´°è³‡è¨Š
```

#### IP ç²å–é‚è¼¯:
```typescript
const getClientIP = (req: Request): string => {
  // å„ªå…ˆç´šé †åº
  const forwarded = req.headers.get('x-forwarded-for');
  if (forwarded) return forwarded.split(',')[0].trim();
  
  return req.headers.get('x-real-ip') ||          // Nginx
         req.headers.get('cf-connecting-ip') ||   // Cloudflare
         'unknown';
};
```

#### æ‰€æœ‰ Edge Functions ç¾åœ¨éƒ½è¨˜éŒ„:
- âœ… å®¢æˆ¶ç«¯ IP
- âœ… ç”¨æˆ¶ ID
- âœ… æ“ä½œé¡å‹
- âœ… æ“ä½œæ™‚é–“
- âœ… æ“ä½œè©³æƒ…

---

### 6ï¸âƒ£ **å®‰å…¨ç®¡ç† UI**

**æ–°å¢çµ„ä»¶**: `src/components/admin/SecurityManager.tsx`

#### å››å¤§ç®¡ç†æ¨¡çµ„:

##### ğŸ“‹ **ç”¨æˆ¶å°é–ç®¡ç†**
- æŸ¥çœ‹æ‰€æœ‰å°é–è¨˜éŒ„
- é¡¯ç¤ºç”¨æˆ¶è³‡è¨Šï¼ˆæš±ç¨±ã€Emailï¼‰
- å°é–é¡å‹æ¨™è¨˜ï¼ˆæ°¸ä¹…/è‡¨æ™‚/è­¦å‘Šï¼‰
- å°é–åŸå› å’Œè©³æƒ…
- ä¸€éµè§£é™¤å°é–
- ç‹€æ…‹é¡¯ç¤ºï¼ˆå·²å°é–/å·²è§£é™¤ï¼‰

##### ğŸŒ **IP é»‘åå–®ç®¡ç†**
- æŸ¥çœ‹æ‰€æœ‰ IP å°é–
- IP åœ°å€é¡¯ç¤ºï¼ˆç­‰å¯¬å­—é«”ï¼‰
- å°é–é¡å‹æ¨™è¨˜
- é•è¦æ¬¡æ•¸çµ±è¨ˆ
- æœ€å¾Œé•è¦æ™‚é–“
- ä¸€éµè§£é™¤å°é–

##### ğŸ” **æ•æ„Ÿè©ç®¡ç†**
- æŸ¥çœ‹æ‰€æœ‰æ•æ„Ÿè©
- æŒ‰é¡åˆ¥é¡¯ç¤º
- è™•ç†å‹•ä½œæ¨™è¨˜
- åš´é‡åº¦è¦–è¦ºåŒ–
- å•Ÿç”¨/åœç”¨ç‹€æ…‹

##### ğŸ“œ **å¯©è¨ˆæ—¥èªŒæŸ¥çœ‹å™¨**
- æŸ¥çœ‹æœ€è¿‘ 100 æ¢è¨˜éŒ„
- æ“ä½œæ™‚é–“é¡¯ç¤º
- æ“ä½œé¡å‹æ¨™è¨˜
- ç”¨æˆ¶ ID
- IP åœ°å€ï¼ˆç­‰å¯¬å­—é«”ï¼‰
- æ“ä½œè©³æƒ…é è¦½

#### æ•´åˆåˆ°å¾Œå°:
```tsx
// AdminPage.tsx
<TabsList className="grid w-full grid-cols-6">
  ...
  <TabsTrigger value="security">å®‰å…¨ç®¡ç†</TabsTrigger>
</TabsList>

<TabsContent value="security">
  <SecurityManager />
</TabsContent>
```

---

## ğŸ“ æª”æ¡ˆæ¸…å–®

### æ–°å¢æª”æ¡ˆï¼ˆ2å€‹ï¼‰:

1. **`supabase/migrations/20250115000005_security_enhancements.sql`**
   - ç”¨æˆ¶å°é–è¡¨
   - IP é»‘åå–®è¡¨
   - æ•æ„Ÿè©è¡¨
   - 4å€‹ RPC å‡½æ•¸
   - æ‰€æœ‰ RLS æ”¿ç­–

2. **`src/components/admin/SecurityManager.tsx`**
   - 4å€‹ç®¡ç†æ¨¡çµ„
   - å®Œæ•´çš„ UI
   - ~500 è¡Œç¨‹å¼ç¢¼

### ä¿®æ”¹æª”æ¡ˆï¼ˆ6å€‹ï¼‰:

3. `supabase/functions/cast-vote/index.ts`
4. `supabase/functions/cast-free-vote/index.ts`
5. `supabase/functions/create-topic/index.ts`
6. `supabase/functions/watch-ad/index.ts`
7. `supabase/functions/complete-mission/index.ts`
8. `src/pages/AdminPage.tsx`

---

## ğŸ“Š è³‡æ–™åº«è®Šæ›´

### æ–°å¢è¡¨ï¼ˆ3å€‹ï¼‰:
| è¡¨å | ç”¨é€” | è¨˜éŒ„æ•¸ |
|------|------|--------|
| `user_blocks` | ç”¨æˆ¶å°é–è¨˜éŒ„ | å‹•æ…‹ |
| `ip_blacklist` | IP é»‘åå–® | å‹•æ…‹ |
| `sensitive_words` | æ•æ„Ÿè©åº« | 17å€‹ï¼ˆé è¨­ï¼‰|

### æ–°å¢æšèˆ‰ï¼ˆ5å€‹ï¼‰:
- `block_type` - å°é–é¡å‹
- `block_reason` - å°é–åŸå› 
- `ip_block_type` - IP å°é–é¡å‹
- `sensitive_word_category` - æ•æ„Ÿè©é¡åˆ¥
- `filter_action` - éæ¿¾å‹•ä½œ

### æ–°å¢ RPCï¼ˆ4å€‹ï¼‰:
| å‡½æ•¸å | åŠŸèƒ½ | è¿”å›å€¼ |
|--------|------|--------|
| `is_user_blocked(uuid)` | æª¢æŸ¥ç”¨æˆ¶å°é– | BOOLEAN |
| `is_ip_blocked(text)` | æª¢æŸ¥ IP å°é– | BOOLEAN |
| `record_ip_violation(...)` | è¨˜éŒ„ IP é•è¦ | JSONB |
| `check_content_for_sensitive_words(text)` | å…§å®¹éæ¿¾ | JSONB |

### æ–°å¢ç´¢å¼•ï¼ˆ7å€‹ï¼‰:
```sql
idx_user_blocks_user_id      -- ç”¨æˆ¶æŸ¥è©¢
idx_user_blocks_active        -- æ´»èºå°é–
idx_user_blocks_expires       -- éæœŸæª¢æŸ¥
idx_ip_blacklist_ip           -- IP æŸ¥è©¢
idx_ip_blacklist_active       -- æ´»èº IP
idx_sensitive_words_category  -- é¡åˆ¥æŸ¥è©¢
idx_sensitive_words_active    -- æ´»èºè©
idx_audit_logs_ip             -- IP è¿½è¹¤
```

---

## ğŸ” å®‰å…¨èƒ½åŠ›å°æ¯”

### âŒ æ”¹é€²å‰:
- ç„¡æ³•å°é–æƒ¡æ„ç”¨æˆ¶
- ç„¡æ³•å°é–æƒ¡æ„ IP
- ç„¡å…§å®¹éæ¿¾æ©Ÿåˆ¶
- IP æœªè¢«è¨˜éŒ„
- CORS å…è¨±æ‰€æœ‰ä¾†æº
- ç„¡å®‰å…¨ç®¡ç†ç•Œé¢

### âœ… æ”¹é€²å¾Œ:
- âœ… å¯å°é–/è§£å°ç”¨æˆ¶ï¼ˆ3ç¨®é¡å‹ï¼‰
- âœ… å¯å°é–/è§£å° IPï¼ˆè‡ªå‹•å‡ç´šï¼‰
- âœ… 17å€‹é è¨­æ•æ„Ÿè© + å¯æ“´å±•
- âœ… æ‰€æœ‰è«‹æ±‚è¨˜éŒ„ IP
- âœ… CORS ç™½åå–®é™åˆ¶
- âœ… å®Œæ•´çš„å¾Œå°ç®¡ç† UI

---

## ğŸ“ˆ å®‰å…¨è©•åˆ†è®ŠåŒ–

### è©³ç´°è©•åˆ†:

| å®‰å…¨é …ç›® | æ”¹é€²å‰ | æ”¹é€²å¾Œ | æå‡ |
|----------|--------|--------|------|
| èªè­‰å®‰å…¨ | 85 | **90** | +5 |
| è³‡æ–™ä¿è­· | 90 | **95** | +5 |
| è¼¸å…¥é©—è­‰ | 85 | **90** | +5 |
| API å®‰å…¨ | 80 | **90** | +10 |
| éš±ç§ä¿è­· | 75 | **85** | +10 |
| **é¢¨æ§ç³»çµ±** | 50 | **80** | **+30** â­ |
| **å¯©è¨ˆè¿½è¹¤** | 65 | **85** | **+20** â­ |
| Session ç®¡ç† | 80 | **85** | +5 |
| **å…§å®¹å¯©æ ¸** | 0 | **75** | **+75** â­ |
| **ç”¨æˆ¶ç®¡ç†** | 0 | **85** | **+85** â­ |

### ç¸½é«”è©•åˆ†:

```
æ”¹é€²å‰  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  82/100 (B+)
æ”¹é€²å¾Œ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  90/100 (A)  âœ…

è©•ç´šæå‡: B+ â†’ A
åˆ†æ•¸æå‡: +8 åˆ†
```

---

## ğŸ›¡ï¸ é˜²è­·èƒ½åŠ›

### ç¬¬ä¸€éšæ®µå·²é˜²è­·ï¼ˆ6é …ï¼‰:
1. âœ… XSS è·¨ç«™è…³æœ¬æ”»æ“Š
2. âœ… SQL æ³¨å…¥æ”»æ“Š
3. âœ… CSRF è·¨ç«™è«‹æ±‚å½é€ 
4. âœ… æš´åŠ›ç ´è§£æ”»æ“Š
5. âœ… é‡æ”¾æ”»æ“Š
6. âœ… è³‡æ–™æ“æ§

### ä¸­æœŸæ–°å¢é˜²è­·ï¼ˆ6é …ï¼‰:
7. âœ… **æƒ¡æ„ç”¨æˆ¶æ”»æ“Š** - ç”¨æˆ¶å°é–
8. âœ… **IP å±¤æ”»æ“Š** - IP é»‘åå–®
9. âœ… **åƒåœ¾å…§å®¹** - æ•æ„Ÿè©éæ¿¾
10. âœ… **è©é¨™å…§å®¹** - è‡ªå‹•æª¢æ¸¬
11. âœ… **å¤šé‡å¸³è™Ÿ** - è¿½è¹¤èˆ‡å°é–
12. âœ… **æŠ•ç¥¨æ“æ§** - é›™é‡é˜²è­·

---

## ğŸš€ å¯¦éš›ä½¿ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: è™•ç†åƒåœ¾è¨Šæ¯ç”¨æˆ¶

**å ´æ™¯**: ç”¨æˆ¶é€£çºŒç™¼é€åƒåœ¾ä¸»é¡Œ

**æ“ä½œæ­¥é©Ÿ**:
1. ç™»å…¥å¾Œå° â†’ å®‰å…¨ç®¡ç† â†’ ç”¨æˆ¶å°é–
2. æ‰¾åˆ°è©²ç”¨æˆ¶
3. é»æ“Šã€Œå°é–ã€
4. é¸æ“‡ã€Œæ°¸ä¹…å°é–ã€
5. åŸå› é¸ã€Œspamã€
6. å¡«å¯«è©³æƒ…ï¼šã€Œé€£çºŒç™¼é€10å€‹åƒåœ¾ä¸»é¡Œã€
7. ç¢ºèªå°é–

**çµæœ**:
- âœ… ç”¨æˆ¶ç„¡æ³•ç™»å…¥
- âœ… ç„¡æ³•æŠ•ç¥¨æˆ–ç™¼å¸–
- âœ… è¨˜éŒ„åˆ°å¯©è¨ˆæ—¥èªŒ
- âœ… å¯éš¨æ™‚è§£é™¤

---

### æ¡ˆä¾‹ 2: è‡ªå‹•å°é–æƒ¡æ„ IP

**å ´æ™¯**: æŸ IP ä¸æ–·å˜—è©¦æ”»æ“Š

**è‡ªå‹•æµç¨‹**:
```typescript
// åœ¨ Edge Function ä¸­
const clientIP = getClientIP(req);

// æ¯æ¬¡é•è¦éƒ½è¨˜éŒ„
const { data } = await supabase.rpc('record_ip_violation', {
  violation_ip: clientIP,
  violation_reason: 'Rapid fire requests'
});

// ç¬¬5æ¬¡é•è¦æ™‚è‡ªå‹•æ°¸ä¹…å°é–
if (data.violation_count >= 5) {
  // å·²è‡ªå‹•å‡ç´šç‚º permanent
  console.log('IP auto-blocked:', clientIP);
}
```

**çµæœ**:
- é•è¦ 1-4 æ¬¡ â†’ æ¨™è¨˜ç‚ºå¯ç–‘
- é•è¦ â‰¥ 5 æ¬¡ â†’ è‡ªå‹•æ°¸ä¹…å°é–
- ç®¡ç†å“¡å¯åœ¨å¾Œå°æŸ¥çœ‹

---

### æ¡ˆä¾‹ 3: å…§å®¹è‡ªå‹•éæ¿¾

**å ´æ™¯**: ç”¨æˆ¶å˜—è©¦ç™¼å¸ƒè©é¨™å…§å®¹

**æª¢æŸ¥æµç¨‹**:
```typescript
// åœ¨ create-topic Edge Function
const content = title + ' ' + description;

const { data: filterResult } = await supabase
  .rpc('check_content_for_sensitive_words', { content });

if (filterResult.has_sensitive_words) {
  if (filterResult.recommended_action === 'block') {
    return new Response(
      JSON.stringify({ 
        error: 'å…§å®¹åŒ…å«æ•æ„Ÿè©ï¼Œç„¡æ³•ç™¼å¸ƒ',
        words: filterResult.found_words 
      }),
      { status: 400 }
    );
  }
  
  if (filterResult.recommended_action === 'review') {
    // å…è¨±ç™¼å¸ƒä½†æ¨™è¨˜ç‚ºå¾…å¯©æ ¸
    approval_status = 'pending';
  }
}
```

**å¯èƒ½çµæœ**:
- åŒ…å«ã€Œå…è²»ä»£å¹£ã€â†’ é˜»æ­¢ç™¼å¸ƒ
- åŒ…å«ã€Œé™æ™‚å„ªæƒ ã€â†’ æ¨™è¨˜å¯©æ ¸
- åŒ…å«ã€Œå¹¹ã€â†’ æ›¿æ›ç‚º ***

---

### æ¡ˆä¾‹ 4: æŸ¥çœ‹ç•°å¸¸æ“ä½œ

**å ´æ™¯**: åˆ†æç³»çµ±å®‰å…¨ç‹€æ³

**æ“ä½œæ­¥é©Ÿ**:
1. å¾Œå° â†’ å®‰å…¨ç®¡ç† â†’ å¯©è¨ˆæ—¥èªŒ
2. æŸ¥çœ‹æœ€è¿‘æ“ä½œè¨˜éŒ„
3. æ³¨æ„åˆ°æŸ IP é »ç¹å‡ºç¾
4. è¤‡è£½ IP åœ°å€
5. åˆ‡æ›åˆ°ã€ŒIP é»‘åå–®ã€åˆ†é 
6. æœå°‹è©² IP
7. æŸ¥çœ‹é•è¦æ¬¡æ•¸
8. å¦‚éœ€è¦ï¼Œæ‰‹å‹•å°é–

**è¿½è¹¤è³‡è¨Š**:
- ğŸ“… æ“ä½œæ™‚é–“
- ğŸ”§ æ“ä½œé¡å‹
- ğŸ‘¤ ç”¨æˆ¶ ID
- ğŸŒ IP åœ°å€
- ğŸ“± è¨­å‚™è³‡è¨Š

---

## ğŸ“‹ éƒ¨ç½²æ­¥é©Ÿ

### 1. è³‡æ–™åº«é·ç§»

```bash
# æ–¹æ³•ä¸€: Supabase CLI
supabase db push

# æ–¹æ³•äºŒ: Supabase Dashboard
1. ç™»å…¥ https://supabase.com/dashboard
2. é¸æ“‡å°ˆæ¡ˆ
3. SQL Editor â†’ New query
4. è¤‡è£½è²¼ä¸Šé·ç§»æª”æ¡ˆå…§å®¹
5. åŸ·è¡Œ
```

### 2. é©—è­‰é·ç§»

```sql
-- æª¢æŸ¥è¡¨æ˜¯å¦å‰µå»º
SELECT tablename FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('user_blocks', 'ip_blacklist', 'sensitive_words');

-- æª¢æŸ¥å‡½æ•¸æ˜¯å¦å­˜åœ¨
SELECT proname FROM pg_proc 
WHERE proname LIKE '%block%' OR proname LIKE '%sensitive%';

-- æª¢æŸ¥é è¨­æ•æ„Ÿè©
SELECT COUNT(*) FROM sensitive_words;  -- æ‡‰è©²æ˜¯ 17
```

### 3. é‡æ–°éƒ¨ç½² Edge Functions

```bash
# éƒ¨ç½²æ‰€æœ‰æ›´æ–°çš„å‡½æ•¸
supabase functions deploy cast-vote
supabase functions deploy cast-free-vote
supabase functions deploy create-topic
supabase functions deploy watch-ad
supabase functions deploy complete-mission
```

### 4. æ¸¬è©¦åŠŸèƒ½

```bash
# å®‰è£ä¾è³´ï¼ˆå¦‚æœé‚„æ²’åšï¼‰
npm install

# å•Ÿå‹•é–‹ç™¼æœå‹™å™¨
npm run dev

# æ¸¬è©¦å®‰å…¨ç®¡ç†é é¢
1. ä»¥ç®¡ç†å“¡ç™»å…¥
2. è¨ªå•å¾Œå° â†’ å®‰å…¨ç®¡ç†
3. æ¸¬è©¦å„å€‹åˆ†é 
```

---

## âš ï¸ æ³¨æ„äº‹é …

### é‡è¦æé†’:

1. **âš ï¸ è³‡æ–™åº«é·ç§»ä¸å¯é€†**
   - åŸ·è¡Œå‰è«‹å‚™ä»½è³‡æ–™åº«
   - å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œ

2. **âš ï¸ CORS ç™½åå–®**
   - ç”Ÿç”¢ç’°å¢ƒè«‹æ›´æ–° `ALLOWED_ORIGINS`
   - æ·»åŠ æ‚¨çš„æ­£å¼åŸŸå

3. **âš ï¸ æ•æ„Ÿè©ç®¡ç†**
   - é è¨­æ•æ„Ÿè©ç‚ºåƒè€ƒ
   - è«‹æ ¹æ“šæ‚¨çš„éœ€æ±‚èª¿æ•´
   - å¯èƒ½æœ‰èª¤åˆ¤ï¼Œéœ€è¦äººå·¥å¯©æ ¸

4. **âš ï¸ IP å°é–**
   - å°å¿ƒå°é– NAT å¾Œçš„ IP
   - å¯èƒ½å½±éŸ¿å¤šå€‹ç”¨æˆ¶
   - å»ºè­°é…åˆç”¨æˆ¶å°é–ä½¿ç”¨

---

## ğŸ¯ å¾ŒçºŒå»ºè­°

### çŸ­æœŸï¼ˆ1é€±å…§ï¼‰:

1. **æ•´åˆåˆ°æŠ•ç¥¨æµç¨‹**
   ```typescript
   // æŠ•ç¥¨å‰æª¢æŸ¥
   const isBlocked = await is_user_blocked(user.id);
   const isIPBlocked = await is_ip_blocked(clientIP);
   
   if (isBlocked || isIPBlocked) {
     throw new Error('æ‚¨å·²è¢«å°é–');
   }
   ```

2. **æ•´åˆåˆ°ç™¼å¸–æµç¨‹**
   ```typescript
   // ç™¼å¸–å‰éæ¿¾
   const filterResult = await check_content_for_sensitive_words(content);
   
   if (filterResult.recommended_action === 'block') {
     throw new Error('å…§å®¹åŒ…å«æ•æ„Ÿè©');
   }
   ```

3. **æ·»åŠ å°é–/è§£å°æŒ‰éˆ•**
   - åœ¨ç”¨æˆ¶åˆ—è¡¨æ·»åŠ å¿«é€Ÿå°é–
   - åœ¨ä¸»é¡Œè©³æƒ…æ·»åŠ å°é–ä½œè€…

---

### ä¸­æœŸï¼ˆ1å€‹æœˆå…§ï¼‰:

4. **é¢¨æ§å„€è¡¨æ¿**
   - å°é–çµ±è¨ˆåœ–è¡¨
   - é•è¦è¶¨å‹¢åˆ†æ
   - ç†±é–€ IP æ’è¡Œ

5. **æ•æ„Ÿè©ç®¡ç†å¢å¼·**
   - æ–°å¢æ•æ„Ÿè© UI
   - æ‰¹æ¬¡åŒ¯å…¥/åŒ¯å‡º
   - æ­£å‰‡åŒ¹é…æ”¯æ´

6. **è‡ªå‹•åŒ–è¦å‰‡**
   - è‡ªå‹•è§£å°è¦å‰‡
   - éƒµä»¶é€šçŸ¥
   - Webhook æ•´åˆ

---

## ğŸŠ æˆå°±ç¸½çµ

### è§£é–æˆå°±:

- ğŸ”’ **å®‰å…¨å°ˆå®¶ II** - å¯¦ç¾å®Œæ•´å®‰å…¨ç³»çµ±
- ğŸ›¡ï¸ **é˜²ç¦¦å¤§å¸« II** - å¤šå±¤æ¬¡é˜²è­·
- ğŸ‘¥ **ç”¨æˆ¶ç®¡ç†è€…** - ç”¨æˆ¶å°é–ç³»çµ±
- ğŸŒ **ç¶²è·¯å®ˆè¡›** - IP é»‘åå–®
- ğŸ” **å…§å®¹å¯©æ ¸å“¡** - æ•æ„Ÿè©éæ¿¾
- ğŸ“Š **Aç´šå®‰å…¨** - é”åˆ° 90 åˆ†

### å°ˆæ¡ˆç‹€æ…‹:

| é …ç›® | ç‹€æ…‹ |
|------|------|
| åŠŸèƒ½å®Œæˆåº¦ | 80% |
| å®‰å…¨è©•åˆ† | 90/100 (A) |
| å¯ä¸Šç·šç‹€æ…‹ | âœ… æ˜¯ |
| æ¨è–¦è¡Œå‹• | é€²è¡Œå…§æ¸¬ |

---

## ğŸ“ å¿«é€Ÿåƒè€ƒ

### å¸¸ç”¨ RPC å‡½æ•¸:

```sql
-- æª¢æŸ¥ç”¨æˆ¶å°é–
SELECT is_user_blocked('user-uuid');

-- æª¢æŸ¥ IP å°é–
SELECT is_ip_blocked('192.168.1.1');

-- è¨˜éŒ„ IP é•è¦
SELECT record_ip_violation('192.168.1.1', 'Spam');

-- å…§å®¹éæ¿¾
SELECT check_content_for_sensitive_words('è¦æª¢æŸ¥çš„å…§å®¹');
```

### å¾Œå°è·¯å¾‘:

```
/admin â†’ å¾Œå°ç®¡ç†
  â”œâ”€ å…¬å‘Šç®¡ç†
  â”œâ”€ æª¢èˆ‰ç®¡ç†
  â”œâ”€ ä¸»é¡Œå¯©æ ¸
  â”œâ”€ å®‰å…¨ç®¡ç† â­ (æ–°å¢)
  â”œâ”€ UIæ–‡å­—ç®¡ç†
  â””â”€ ç³»çµ±é…ç½®
```

---

## ğŸ‰ æœ€çµ‚ç¸½çµ

**VoteChaos ç¾å·²å…·å‚™ä¼æ¥­ç´šå®‰å…¨é˜²è­·ï¼**

### æ ¸å¿ƒèƒ½åŠ›:
- âœ… å®Œæ•´çš„ç”¨æˆ¶ç®¡ç†
- âœ… IP å±¤é˜²è­·
- âœ… å…§å®¹è‡ªå‹•éæ¿¾
- âœ… å¯©è¨ˆè¿½è¹¤å®Œæ•´
- âœ… å¾Œå°ç®¡ç†å®Œå–„

### å®‰å…¨ç‹€æ³:
```
æ”¹é€²å‰: B+ ç´šï¼ˆ82 åˆ†ï¼‰âœ… è‰¯å¥½
æ”¹é€²å¾Œ: A ç´šï¼ˆ90 åˆ†ï¼‰â­ å„ªç§€

æå‡: +8 åˆ†
```

### å¯ä»¥:
- âœ… å®‰å¿ƒé€²è¡Œå…§æ¸¬
- âœ… é˜²è­·å¸¸è¦‹æ”»æ“Š
- âœ… ç®¡ç†æƒ¡æ„ç”¨æˆ¶
- âœ… éæ¿¾æ•æ„Ÿå…§å®¹
- âœ… è¿½è¹¤æ‰€æœ‰æ“ä½œ

---

**æ­å–œï¼æ‚¨çš„å°ˆæ¡ˆå·²é”åˆ°å„ªç§€çš„å®‰å…¨æ¨™æº–ï¼** ğŸš€âœ¨

**ä¸‹ä¸€æ­¥**: åŸ·è¡Œè³‡æ–™åº«é·ç§» â†’ æ¸¬è©¦åŠŸèƒ½ â†’ æº–å‚™ä¸Šç·šï¼


