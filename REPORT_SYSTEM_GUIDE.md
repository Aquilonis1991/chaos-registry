# 檢舉系統使用指南

## 📋 系統概述

檢舉系統允許用戶（包括匿名用戶）檢舉不當內容，管理員可以在後台查看和處理所有檢舉。系統會記錄所有檢舉並提供完整的審核流程。

## 🎯 主要功能

### 1. **前台檢舉功能**
- ✅ 9種檢舉類型（仇恨言論、色情內容、暴力、違法、垃圾訊息、釣魚、虛假訊息、騷擾、其他）
- ✅ 支援匿名和登入用戶檢舉
- ✅ 詳細的檢舉原因和說明欄位
- ✅ 防止重複檢舉機制
- ✅ 友善的UI/UX設計

### 2. **後台管理功能**
- ✅ 檢舉統計儀表板
- ✅ 按狀態分類查看（全部/待處理/審核中/已處理/已駁回）
- ✅ 檢舉詳情查看
- ✅ 快速操作按鈕
- ✅ 管理員備註和處理結果記錄
- ✅ 審核歷史追蹤

## 🗄️ 資料庫結構

### Reports 表格欄位：
```sql
- id: UUID (主鍵)
- reporter_id: UUID (檢舉人ID，可為空)
- reporter_email: TEXT (檢舉人郵箱)
- target_type: TEXT (檢舉對象類型: topic/user/comment)
- target_id: UUID (檢舉對象ID)
- report_type: ENUM (檢舉類型)
- reason: TEXT (檢舉原因，最多500字)
- details: TEXT (詳細說明，最多2000字，選填)
- status: ENUM (狀態: pending/reviewing/resolved/rejected/closed)
- reviewed_by: UUID (審核者ID)
- reviewed_at: TIMESTAMPTZ (審核時間)
- admin_notes: TEXT (管理員備註)
- resolution: TEXT (處理結果)
- created_at: TIMESTAMPTZ (創建時間)
- updated_at: TIMESTAMPTZ (更新時間)
```

### 檢舉類型說明：
| 類型 | 代碼 | 圖標 | 說明 |
|------|------|------|------|
| 仇恨言論 | hate_speech | 🚫 | 包含歧視、仇恨或攻擊特定群體的內容 |
| 色情內容 | sexual_content | ❤️ | 包含色情、裸露或性暗示的內容 |
| 暴力內容 | violence | ⚡ | 包含暴力、血腥或危險行為的內容 |
| 違法內容 | illegal | ⚖️ | 包含非法活動或違反法律的內容 |
| 垃圾訊息 | spam | ✉️ | 重複、無意義或廣告性質的內容 |
| 釣魚詐騙 | phishing | 🔗 | 試圖詐騙或竊取個人資訊的內容 |
| 虛假訊息 | misinformation | ⚠️ | 故意傳播錯誤或誤導性的資訊 |
| 騷擾 | harassment | 🛡️ | 針對性的騷擾、欺凌或威脅 |
| 其他 | other | ℹ️ | 其他違反社群規範的內容 |

### 檢舉狀態流程：
```
pending (待處理) → reviewing (審核中) → resolved (已處理) / rejected (已駁回)
                                      ↓
                                   closed (已關閉)
```

## 🔧 使用方式

### **前台用戶檢舉**

1. **在主題詳情頁**：
   - 點擊主題資訊旁的「檢舉」按鈕
   - 選擇檢舉類型
   - 填寫檢舉原因（必填，最多500字）
   - 填寫詳細說明（選填，最多2000字）
   - 匿名用戶需提供聯絡郵箱
   - 點擊「提交檢舉」

2. **防重複機制**：
   - 同一用戶對同一對象的相同類型檢舉只能提交一次
   - 系統會提示「您已經檢舉過此內容」

### **後台管理員審核**

1. **進入檢舉管理**：
   - 訪問 `/admin` 頁面
   - 點擊「檢舉管理」分頁

2. **查看統計資料**：
   - 總檢舉數
   - 待處理數量（需要關注）
   - 審核中數量
   - 已處理數量
   - 已駁回數量

3. **處理檢舉**：
   - **快速操作**（僅限待處理狀態）：
     - 點擊 🕒 標記為審核中
     - 點擊 ✓ 標記為已處理
     - 點擊 ✕ 標記為已駁回
   
   - **詳細處理**：
     - 點擊 👁️ 查看檢舉詳情
     - 更新處理狀態
     - 填寫管理員備註（內部使用）
     - 填寫處理結果（可見給用戶）
     - 點擊「更新狀態」

4. **篩選查看**：
   - 全部：查看所有檢舉
   - 待處理：需要處理的新檢舉
   - 審核中：正在處理的檢舉
   - 已處理：已完成處理的檢舉
   - 已駁回：認為無效的檢舉

## 📧 郵件通知功能（預留）

系統配置中預留了郵件通知相關設定：

```javascript
report_email_notifications: 'true'  // 是否發送郵件通知
report_admin_email: 'admin@votechaos.com'  // 接收通知的管理員郵箱
```

**未來可擴展：**
- 新檢舉自動發送郵件給管理員
- 檢舉處理完成後通知檢舉人
- 被檢舉用戶收到警告通知

## 🔒 安全機制

### Row Level Security (RLS) 政策：

1. **用戶權限**：
   - 所有用戶（包括匿名）都可以提交檢舉
   - 登入用戶可以查看自己的檢舉記錄
   - 防止重複檢舉同一內容

2. **管理員權限**：
   - 查看所有檢舉
   - 更新檢舉狀態
   - 刪除檢舉記錄
   - 查看詳細統計資料

### 防濫用機制：

1. **唯一性約束**：
   ```sql
   CONSTRAINT unique_user_target_report UNIQUE (reporter_id, target_type, target_id, report_type)
   ```

2. **字數限制**：
   - 原因：最多500字
   - 詳細說明：最多2000字

3. **必填欄位驗證**：
   - 檢舉類型（必選）
   - 檢舉原因（必填）
   - 匿名檢舉的郵箱（必填）

## 🚀 部署步驟

1. **運行資料庫遷移**：
   ```bash
   cd supabase
   npx supabase db push
   ```
   這會創建：
   - `reports` 表
   - `report_type` 和 `report_status` 枚舉類型
   - 相關的 RLS 政策
   - 輔助函數（get_report_stats, get_reports_with_details, update_report_status）

2. **驗證部署**：
   - 檢查 Supabase 控制台中的表格是否創建成功
   - 測試 RLS 政策是否生效
   - 確認系統配置已插入

3. **測試功能**：
   - 前台測試檢舉提交
   - 後台測試檢舉管理
   - 測試各種狀態轉換

## 📊 數據庫函數

### 1. `get_report_stats()`
獲取檢舉統計資料
```sql
SELECT * FROM get_report_stats();
```
返回：總數、待處理、審核中、已處理、已駁回的數量

### 2. `get_reports_with_details(p_status, p_limit, p_offset)`
獲取檢舉列表及相關詳情
```sql
SELECT * FROM get_reports_with_details('pending'::report_status, 50, 0);
```
返回：檢舉列表及檢舉對象的標題資訊

### 3. `update_report_status(p_report_id, p_status, p_admin_notes, p_resolution)`
更新檢舉狀態
```sql
SELECT update_report_status(
  '檢舉ID'::uuid,
  'resolved'::report_status,
  '管理員備註',
  '處理結果'
);
```

## 💡 最佳實踐

### 管理員處理建議：

1. **優先處理順序**：
   - 仇恨言論、違法內容 → 最高優先級
   - 騷擾、釣魚詐騙 → 高優先級
   - 色情、暴力內容 → 中優先級
   - 垃圾訊息、其他 → 一般優先級

2. **處理流程**：
   - 新檢舉 → 標記為「審核中」
   - 調查內容 → 決定是否違規
   - 採取措施 → 隱藏/刪除內容或警告用戶
   - 更新狀態 → 「已處理」或「已駁回」
   - 記錄結果 → 填寫處理結果供日後參考

3. **備註規範**：
   - 管理員備註：內部溝通使用，記錄判斷依據
   - 處理結果：可能對用戶可見，簡要說明處理方式

## 🔮 未來擴展方向

1. **自動化處理**：
   - 達到一定檢舉數自動隱藏內容
   - AI 輔助檢測違規內容
   - 自動分類檢舉優先級

2. **通知系統**：
   - 實時郵件通知管理員
   - 檢舉處理結果通知檢舉人
   - 被檢舉用戶收到警告

3. **數據分析**：
   - 檢舉趨勢分析
   - 違規內容熱點
   - 用戶行為模式分析

4. **多層級審核**：
   - 初級審核員
   - 高級審核員
   - 申訴機制

## ⚠️ 注意事項

1. **隱私保護**：
   - 檢舉人資訊應保密
   - 僅管理員可查看完整檢舉詳情

2. **公平性**：
   - 避免主觀判斷
   - 依據明確的社群規範
   - 記錄處理依據

3. **響應時效**：
   - 高優先級檢舉應在24小時內處理
   - 一般檢舉應在3天內處理
   - 定期清理已處理的舊檢舉

## 📞 支援

如有問題或建議，請聯繫系統管理員。

