# X (Twitter) 登入 - 401 錯誤完整解決

> **建立日期**：2025-01-29  
> **錯誤**：`{"code":401,"message":"缺少授權標頭"}`  
> **原因**：Supabase Edge Functions 預設需要 JWT，但 OAuth 回調沒有

---

## 🔍 錯誤分析

### 錯誤訊息

```
https://epyykzxxglkjombvozhr.supabase.co/functions/v1/twitter-auth/callback?state=...&code=...
{"code":401,"message":"缺少授權標頭"}
```

### 問題根源

**Supabase Edge Functions 預設會驗證 JWT**，但 OAuth 回調請求來自 X 的伺服器，不會包含 Supabase 的 JWT。

**這是一個 Supabase 的配置問題**，需要在 Supabase Dashboard 中設置 Edge Function 為公開訪問。

---

## 🔧 解決方案

### 方案 1：在 Supabase Dashboard 中設置 Edge Function 為公開訪問（最重要）

**詳細步驟**：

1. **登入 [Supabase Dashboard](https://app.supabase.com/)**

2. **進入 Edge Functions**：
   - 左側選單 → **Edge Functions**

3. **找到 `twitter-auth` 函數**：
   - 在函數列表中，找到 `twitter-auth`
   - 點擊函數名稱進入詳細頁面

4. **檢查函數設定**：
   - 查看是否有 **「Settings」** 或 **「Configuration」** 選項
   - 查看是否有 **「JWT Verification」** 或 **「Require Authentication」** 選項

5. **如果找到 JWT 驗證選項**：
   - **關閉**或**禁用** JWT 驗證
   - 這將允許公開訪問（不需要 JWT）
   - 點擊 **「Save」**

6. **如果找不到此選項**：
   - Supabase Edge Functions 預設應該是公開的
   - 問題可能在其他地方
   - 繼續查看方案 2

---

### 方案 2：檢查 Supabase 專案的全域設定

**檢查 Edge Functions 的全域設定**：

1. **進入 Settings → Edge Functions**

2. **檢查全域設定**：
   - 查看是否有 **「Require JWT for all functions」** 的選項
   - 如果有，確認是否啟用
   - 如果啟用，**關閉**它（或為特定函數設置例外）

---

### 方案 3：檢查 Edge Function 日誌

**查看詳細錯誤資訊**：

1. **進入 Edge Functions → twitter-auth → Logs**

2. **查看最近的請求日誌**：
   - 找到返回 401 錯誤的請求
   - 查看完整的錯誤訊息
   - 查看請求詳情（headers、method、path 等）

3. **對比 LINE Edge Function**：
   - 查看 `line-auth` 函數的日誌
   - 對比兩者的差異
   - 如果 LINE 正常，查看它的設定

---

### 方案 4：檢查 Edge Function 代碼

**確認代碼沒有要求授權**：

1. **檢查 `twitter-auth/index.ts`**：
   - 確認沒有明確檢查 `Authorization` 標頭
   - 確認沒有調用需要 JWT 的 Supabase API（在回調處理中）

2. **對比 LINE Edge Function**：
   - 查看 `line-auth/index.ts` 的實現
   - 確認兩者的差異

---

### 方案 5：重新部署 Edge Function

**如果設定都正確，嘗試重新部署**：

```bash
cd votechaos-main
npx supabase functions deploy twitter-auth --no-verify-jwt
```

**注意**：`--no-verify-jwt` 標誌可能不存在，但可以嘗試。

或直接重新部署：

```bash
npx supabase functions deploy twitter-auth
```

---

## 🎯 優先行動

### 立即檢查（按順序）

1. **✅ Supabase Dashboard Edge Functions 設定**（最重要）
   - 檢查 `twitter-auth` 函數是否有 JWT 驗證選項
   - 如果有，關閉它

2. **✅ 對比 LINE Edge Function**
   - LINE 登入是否正常工作？
   - 如果 LINE 正常，查看它的設定
   - 對比兩者的差異

3. **✅ Edge Function 日誌**
   - 查看詳細的錯誤訊息
   - 了解為什麼需要授權標頭

4. **✅ 重新部署 Edge Function**
   - 如果設定都正確，嘗試重新部署

---

## 📝 需要確認的資訊

請提供以下資訊：

1. **Supabase Dashboard Edge Functions 設定**：
   - `twitter-auth` 函數的設定頁面截圖
   - 是否有 JWT 驗證選項？
   - 如果有，當前狀態是什麼？

2. **LINE Edge Function 狀態**：
   - LINE 登入是否正常工作？
   - LINE Edge Function 的設定是什麼？

3. **Edge Function 日誌**：
   - 最近的請求日誌詳情
   - 完整的錯誤訊息

---

## 🔗 相關文件

- [X 登入-EdgeFunction實作步驟](./X登入-EdgeFunction實作步驟.md)
- [X 登入-EdgeFunction部署與測試](./X登入-EdgeFunction部署與測試.md)

---

**最後更新**：2025-01-29



