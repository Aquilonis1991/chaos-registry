# X (Twitter) 登入 - 401 錯誤解決

> **建立日期**：2025-01-29  
> **錯誤**：`{"code":401,"message":"缺少授權標頭"}`

---

## 🔍 錯誤分析

### 錯誤訊息

```
https://epyykzxxglkjombvozhr.supabase.co/functions/v1/twitter-auth/callback?state=...&code=...
{"code":401,"message":"缺少授權標頭"}
```

### 問題根源

**X 的回調請求是從 X 的伺服器直接發送到 Edge Function**，不會包含 Supabase 的授權標頭（JWT）。

**Supabase Edge Functions 預設可能需要 JWT 驗證**，導致回調請求被拒絕。

---

## 🔧 解決方案

### 方案 1：在 Supabase Dashboard 中設置 Edge Function 為公開訪問

**檢查 Edge Function 的 JWT 驗證設定**：

1. **登入 [Supabase Dashboard](https://app.supabase.com/)**
2. **進入 Edge Functions**
3. **找到 `twitter-auth` 函數**
4. **點擊函數名稱進入詳細頁面**
5. **檢查設定**：
   - 查看是否有 **「JWT Verification」** 或 **「Require Authentication」** 選項
   - 如果有，**關閉**或**禁用**此選項
   - 這將允許公開訪問（不需要 JWT）

6. **如果找不到此選項**：
   - 檢查函數的 **「Settings」** 或 **「Configuration」**
   - 或查看函數的 **「Permissions」** 設定

---

### 方案 2：檢查 Supabase 專案設定

**確認 Edge Functions 的預設行為**：

1. **進入 Settings → Edge Functions**
2. **檢查全域設定**：
   - 查看是否有 **「Require JWT for all functions」** 的選項
   - 如果有，確認是否啟用

---

### 方案 3：修改 Edge Function 代碼（如果方案 1 不可用）

**如果 Supabase Dashboard 沒有公開訪問選項**，可能需要修改代碼以處理沒有授權標頭的情況。

但實際上，**Supabase Edge Functions 預設應該是公開的**，所以這個錯誤可能是其他原因。

---

### 方案 4：檢查 Edge Function 日誌

**查看詳細錯誤資訊**：

1. **進入 Edge Functions → twitter-auth → Logs**
2. **查看最近的請求日誌**
3. **查看是否有更詳細的錯誤訊息**

---

## 🎯 優先行動

### 立即檢查

1. **✅ Supabase Dashboard Edge Functions 設定**
   - 檢查 `twitter-auth` 函數是否有 JWT 驗證選項
   - 如果有，關閉它

2. **✅ Edge Function 日誌**
   - 查看詳細的錯誤訊息
   - 了解為什麼需要授權標頭

3. **✅ 對比 LINE Edge Function**
   - LINE 的 Edge Function 是否正常工作？
   - 如果 LINE 正常，對比兩者的設定差異

---

## 📝 需要確認的資訊

請提供以下資訊：

1. **Supabase Dashboard Edge Functions 設定**：
   - `twitter-auth` 函數是否有 JWT 驗證選項？
   - 如果有，當前狀態是什麼？（啟用/停用）

2. **Edge Function 日誌**：
   - 最近的請求日誌詳情
   - 完整的錯誤訊息

3. **LINE Edge Function 狀態**：
   - LINE 登入是否正常工作？
   - LINE Edge Function 的設定是什麼？

---

## 🔗 相關文件

- [X 登入-EdgeFunction實作步驟](./X登入-EdgeFunction實作步驟.md)
- [X 登入-EdgeFunction部署與測試](./X登入-EdgeFunction部署與測試.md)

---

**最後更新**：2025-01-29


