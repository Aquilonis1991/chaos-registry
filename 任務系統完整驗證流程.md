# 🎯 任務系統完整驗證流程

## 📋 驗證前準備

### 1. 開啟瀏覽器開發者工具
- 按 `F12` 或 `Ctrl+Shift+I`
- 切換到 **Console** 標籤頁
- 清除之前的日誌（可選）

### 2. 確認測試帳號狀態
- 登入測試帳號
- 確認帳號有足夠的代幣（建議至少 1000 代幣）

---

## ✅ 驗證流程

### 階段一：驗證「新手上路」任務

#### 步驟 1：檢查初始狀態
1. 訪問 **任務頁面** (`/mission`)
2. 查看「新手上路」任務：
   - [ ] 應該顯示 `0% 完成`
   - [ ] 狀態為「進行中」
3. 在 Console 中確認：
   - [ ] 看到 `📊 User Stats:` 日誌
   - [ ] `totalVotes: 0`
   - [ ] `uniqueTopicVotes: 0`

#### 步驟 2：執行第一次投票
1. 返回首頁，選擇任意一個主題
2. 選擇一個選項
3. 點擊「使用代幣投票」按鈕（1 代幣）
   - 或使用「免費投票」按鈕
4. 確認投票成功

#### 步驟 3：驗證任務完成
1. 返回任務頁面 (`/mission`)
2. 檢查「新手上路」任務：
   - [ ] 應該顯示 `100% 完成`
   - [ ] 狀態變為「已完成」✓
   - [ ] 顯示「已完成」按鈕（灰色，不可點擊）
3. 在 Console 中確認：
   - [ ] 看到 `✅ Votes fetched: 1 votes` 或 `✅ Free votes fetched: 1 free votes`
   - [ ] `📊 User Stats:` 中 `totalVotes: 1` 或更大

---

### 階段二：驗證「話題創造者」任務

#### 步驟 1：檢查初始狀態
1. 在任務頁面查看「話題創造者」任務
2. 確認：
   - [ ] 顯示 `0% 完成`
   - [ ] 狀態為「進行中」
3. 在 Console 中確認：
   - [ ] `📊 User Stats:` 中 `topicsCreated: 0`

#### 步驟 2：建立一個主題
1. 點擊底部導航的「+」按鈕，或訪問 `/create`
2. 填寫主題資訊：
   - 標題：測試主題（例如：「測試話題創造者任務」）
   - 描述：可選
   - 選擇分類：任意
   - 添加標籤：可選
   - 添加至少 2 個選項
   - 選擇曝光等級：普通
   - 選擇持續天數：7 天
3. 點擊「建立主題」按鈕
4. 確認主題建立成功

#### 步驟 3：驗證任務完成
1. 返回任務頁面 (`/mission`)
2. 檢查「話題創造者」任務：
   - [ ] 應該顯示 `100% 完成`
   - [ ] 狀態變為「已完成」✓
   - [ ] 顯示「已完成」按鈕
3. 在 Console 中確認：
   - [ ] 看到 `✅ Topics created: 1` 或更大
   - [ ] `📊 User Stats:` 中 `topicsCreated: 1` 或更大

---

### 階段三：驗證「投票愛好者」任務

#### 步驟 1：檢查初始狀態
1. 在任務頁面查看「投票愛好者」任務
2. 確認：
   - [ ] 顯示當前進度（例如：`30% 完成` 如果已投票 3 個不同主題）
   - [ ] 狀態為「進行中」

#### 步驟 2：建立多個測試主題（如果需要的話）
1. 如果首頁沒有足夠的主題，可以：
   - 建立 10 個不同的主題（使用不同帳號或測試帳號）
   - 或使用現有的主題

#### 步驟 3：對 10 個不同主題進行投票
1. 對 **10 個不同的主題** 進行投票：
   - 可以是免費投票或代幣投票
   - **重要**：必須是不同的主題，對同一個主題投票多次不會增加進度
2. 每次投票後，返回任務頁面檢查進度：
   - [ ] 進度應該逐步增加：10%, 20%, 30%, ... 100%
   - [ ] 在 Console 中確認 `uniqueTopicVotes` 增加

#### 步驟 4：驗證任務完成
1. 對第 10 個不同主題投票後
2. 返回任務頁面
3. 檢查「投票愛好者」任務：
   - [ ] 應該顯示 `100% 完成`
   - [ ] 狀態變為「已完成」✓
   - [ ] 顯示「已完成」按鈕
4. 在 Console 中確認：
   - [ ] `📊 User Stats:` 中 `uniqueTopicVotes: 10` 或更大

---

### 階段四：驗證「7天登入」任務

#### 步驟 1：檢查初始狀態
1. 在任務頁面查看「7天登入」任務
2. 確認：
   - [ ] 顯示當前連續登入天數的進度
   - [ ] 例如：如果連續登入 2 天，應該顯示 `28% 完成` (2/7 * 100)

#### 步驟 2：查看登入連勝資訊
1. 在 Console 中確認：
   - [ ] 登入連勝資訊已載入
   - [ ] 查看 `loginStreakInfo.current_streak`

#### 步驟 3：每日簽到
1. 在任務頁面點擊「立即簽到」
2. 確認簽到成功（獲得 3 代幣）
3. 連續簽到 7 天後
4. 檢查「7天登入」任務：
   - [ ] 應該顯示 `100% 完成`
   - [ ] 狀態變為「已完成」✓

---

## 🔍 詳細驗證檢查點

### Console 日誌檢查

每次訪問任務頁面時，應該在 Console 看到：

```
✅ Votes fetched: X votes
✅ Free votes fetched: X free votes
✅ Topics created: X
📊 User Stats: {
  totalVotes: X,
  totalFreeVotes: X,
  topicsCreated: X,
  uniqueTopicVotes: X,
  ...
}
```

### 數據正確性檢查

1. **totalVotes**：
   - 應該是 `votes` 表記錄數 + `free_votes` 表記錄數
   - 用於「新手上路」任務

2. **uniqueTopicVotes**：
   - 應該是投票過的不重複主題數量
   - 用於「投票愛好者」任務
   - **重要**：對同一主題投票多次，此數字不會增加

3. **topicsCreated**：
   - 應該是 `topics` 表中 `creator_id` 等於當前用戶的記錄數
   - 用於「話題創造者」任務

---

## 🐛 常見問題排查

### 問題 1：任務進度不更新

**檢查步驟**：
1. 刷新頁面（`Ctrl+F5` 強制刷新）
2. 檢查 Console 是否有錯誤
3. 確認 `useUserStats` hook 是否正確載入數據
4. 檢查 RLS（Row Level Security）政策是否允許讀取數據

**可能的解決方案**：
```sql
-- 檢查 votes 表的 RLS 政策
-- 應該允許用戶查看自己的投票記錄
SELECT * FROM pg_policies WHERE tablename = 'votes';
```

### 問題 2：投票後任務進度沒有變化

**檢查步驟**：
1. 確認投票是否成功寫入 `votes` 表或 `free_votes` 表
2. 在 Supabase SQL Editor 執行：
```sql
-- 檢查投票記錄
SELECT COUNT(*) FROM public.votes WHERE user_id = '<你的 user_id>';

-- 檢查免費投票記錄
SELECT COUNT(*) FROM public.free_votes WHERE user_id = '<你的 user_id>';

-- 檢查投票過的不同主題數量
SELECT COUNT(DISTINCT topic_id) 
FROM (
  SELECT topic_id FROM public.votes WHERE user_id = '<你的 user_id>'
  UNION
  SELECT topic_id FROM public.free_votes WHERE user_id = '<你的 user_id>'
) AS all_votes;
```

### 問題 3：主題創建後任務不完成

**檢查步驟**：
1. 確認主題是否成功建立
2. 在 Supabase SQL Editor 執行：
```sql
-- 檢查創建的主題
SELECT COUNT(*) FROM public.topics WHERE creator_id = '<你的 user_id>';
```

### 問題 4：Console 顯示錯誤

**常見錯誤**：
- `PGRST116`: 找不到數據（可能是 RLS 政策問題）
- `PGRST202`: 函數不存在（檢查資料庫函數）
- `404`: 表不存在（檢查資料庫表結構）

---

## 📊 SQL 驗證查詢

### 檢查用戶的所有統計數據

```sql
-- 替換 <你的 user_id> 為實際的用戶 ID
WITH user_votes AS (
  SELECT topic_id FROM public.votes WHERE user_id = '<你的 user_id>'
),
user_free_votes AS (
  SELECT topic_id FROM public.free_votes WHERE user_id = '<你的 user_id>'
),
all_votes AS (
  SELECT topic_id FROM user_votes
  UNION
  SELECT topic_id FROM user_free_votes
)
SELECT 
  '總投票次數' AS 項目,
  (SELECT COUNT(*) FROM user_votes) + (SELECT COUNT(*) FROM user_free_votes) AS 數值
UNION ALL
SELECT 
  '投票過的不同主題數' AS 項目,
  (SELECT COUNT(DISTINCT topic_id) FROM all_votes) AS 數值
UNION ALL
SELECT 
  '創建的主題數' AS 項目,
  (SELECT COUNT(*) FROM public.topics WHERE creator_id = '<你的 user_id>') AS 數值;
```

---

## ✅ 驗證完成檢查清單

完成所有階段後，確認：

- [ ] 「新手上路」任務顯示為已完成（✓）
- [ ] 「話題創造者」任務顯示為已完成（✓）
- [ ] 「投票愛好者」任務顯示為已完成（✓）（如果已對 10 個不同主題投票）
- [ ] 「7天登入」任務顯示為已完成（✓）（如果已連續登入 7 天）
- [ ] Console 中所有日誌顯示正確的數據
- [ ] 任務進度條正確更新
- [ ] 沒有 Console 錯誤

---

## 🔄 重置測試（如果需要）

如果需要重置任務進度進行重新測試：

```sql
-- ⚠️ 警告：這會刪除所有投票記錄和主題
-- 僅用於測試環境

-- 刪除所有投票記錄
DELETE FROM public.votes WHERE user_id = '<你的 user_id>';
DELETE FROM public.free_votes WHERE user_id = '<你的 user_id>';

-- 刪除所有創建的主題
DELETE FROM public.topics WHERE creator_id = '<你的 user_id>';

-- 重載 Schema Cache（建議）
SELECT pg_notify('pgrst','reload schema');
```

---

## 📝 驗證結果記錄

| 任務 | 預期結果 | 實際結果 | 狀態 | 備註 |
|------|---------|---------|------|------|
| 新手上路 | 投票後顯示 100% | | ⬜ | |
| 話題創造者 | 創建主題後顯示 100% | | ⬜ | |
| 投票愛好者 | 投票 10 個不同主題後顯示 100% | | ⬜ | |
| 7天登入 | 連續登入 7 天後顯示 100% | | ⬜ | |

---

**驗證完成後，請記錄任何發現的問題或異常行為。**

