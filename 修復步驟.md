# 🔧 修復建立主題功能 - 立即執行步驟

## ❌ 問題診斷

**錯誤訊息**：
```
Could not find the function public.has_free_create_qualification(check_user_id) 
in the schema cache
```

**原因**：資料庫中缺少必要的函數和表格。

## ✅ 解決方案

### 方法 1：在 Supabase Dashboard 執行 SQL（推薦）

#### 步驟 1：登入 Supabase
1. 前往 https://supabase.com/dashboard
2. 登入您的帳號
3. 選擇 VoteChaos 專案

#### 步驟 2：打開 SQL Editor
1. 左側選單點擊 **SQL Editor**
2. 點擊 **New Query**

#### 步驟 3：執行修復 SQL
1. 打開專案中的 `修復建立主題功能.sql` 檔案
2. 複製**全部內容**
3. 貼到 Supabase SQL Editor
4. 點擊 **Run** 或按 `Ctrl+Enter`

#### 步驟 4：確認成功
如果看到：
```
status: "Free create qualification system installed successfully!"
```
表示修復成功！

### 方法 2：使用 Supabase CLI（需要安裝 CLI）

```bash
# 如果您有安裝 Supabase CLI
supabase db push
```

## 🧪 測試修復

執行完 SQL 後：

1. **重新整理瀏覽器**（F5）
2. **清除 Console**（Console 中右鍵 → Clear console）
3. **再次嘗試建立主題**
4. **查看錯誤訊息**

應該會看到不同的訊息（或成功建立）。

## 📋 完整的必要資料庫物件

這個修復 SQL 會建立：

### 1. 表格
- ✅ `free_create_qualifications` - 免費建立資格

### 2. 函數
- ✅ `has_free_create_qualification()` - 檢查是否有免費資格
- ✅ `use_free_create_qualification()` - 使用免費資格
- ✅ `grant_free_create_qualification()` - 授予免費資格

### 3. RLS 政策
- ✅ 用戶可查看自己的資格
- ✅ 用戶可插入自己的資格
- ✅ 用戶可更新自己的資格

### 4. 系統配置
- ✅ `free_create_enabled` - 是否啟用免費建立
- ✅ `free_create_daily_login_days` - 連續登入天數要求
- ✅ `free_create_qualification_expire_hours` - 資格過期時間

## 🎯 預期結果

執行 SQL 後：
1. ✅ 不會再出現 `PGRST202` 錯誤
2. ✅ 建立主題功能應該正常運作
3. ✅ 如果有連續登入 5 天，會顯示「免費建立主題」

## ⚠️ 注意事項

### 如果執行 SQL 時出現錯誤

**錯誤：表格已存在**
```sql
-- 這是正常的，表示表格已經存在
-- SQL 會跳過建立表格，只建立函數
```

**錯誤：權限不足**
```
-- 確認您是專案的 Owner 或有足夠權限
-- 或聯繫專案管理員執行
```

## 🔄 如果還是有問題

執行 SQL 後如果還是無法建立主題，請提供：

1. **SQL 執行結果**（成功或錯誤訊息）
2. **新的 Console 錯誤訊息**（重新整理後再試一次）
3. **Network 標籤中 create-topic 請求的狀態碼**

---

**立即行動**：
1. 登入 Supabase Dashboard
2. 打開 SQL Editor
3. 執行 `修復建立主題功能.sql`
4. 重新整理瀏覽器測試

**預計時間**：2-3 分鐘



