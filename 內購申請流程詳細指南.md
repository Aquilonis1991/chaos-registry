# 內購申請流程詳細指南

## 📋 目錄

1. [Google Play 內購申請流程](#google-play-內購申請流程)
2. [App Store 內購申請流程](#app-store-內購申請流程)
3. [申請後續設定](#申請後續設定)
4. [常見問題與解決方案](#常見問題與解決方案)

---

## 💰 Google Play 內購申請流程

### 前置準備

- ✅ Google 帳號
- ✅ Google Play Console 開發者帳號（一次性費用：$25 USD）
- ✅ 已建立或準備建立的 Android App
- ✅ 銀行帳戶資訊（用於收款）

---

### 步驟 1：註冊 Google Play Console 開發者帳號

#### 1.1 前往 Google Play Console

1. 打開瀏覽器，前往 [Google Play Console](https://play.google.com/console/)
2. 使用您的 Google 帳號登入

#### 1.2 支付開發者註冊費

1. 如果這是第一次使用，系統會提示您支付一次性註冊費：**$25 USD**
2. 點擊「支付」或「立即註冊」
3. 選擇支付方式（信用卡、PayPal 等）
4. 完成支付
5. 等待帳號啟用（通常立即生效，最多 24 小時）

#### 1.3 填寫開發者資訊

1. **開發者名稱**：
   - 輸入您的開發者名稱（例如：`ChaosRegistry`）
   - 這會顯示在 Google Play 商店中
   - 可以稍後修改

2. **聯絡資訊**：
   - 填寫您的電子郵件地址
   - 填寫電話號碼
   - 填寫地址

3. **銀行帳戶資訊**（用於收款）：
   - 選擇您的國家/地區
   - 輸入銀行帳戶資訊
   - 確認銀行帳戶詳情

4. 點擊「儲存」或「完成」

---

### 步驟 2：建立應用程式

#### 2.1 建立新應用

1. 在 Google Play Console 首頁，點擊左上角的「**建立應用程式**」按鈕
2. 如果這是第一次建立，系統會顯示歡迎畫面，點擊「**建立應用程式**」

#### 2.2 填寫應用程式基本資訊

1. **應用程式名稱**：
   - 輸入：`ChaosRegistry`（或您喜歡的名稱）
   - 這是在 Google Play 商店中顯示的名稱
   - 可以稍後修改

2. **預設語言**：
   - 選擇：`繁體中文（台灣）` 或 `繁體中文（香港）`

3. **應用程式或遊戲**：
   - 選擇：**「應用程式」**

4. **免費或付費**：
   - 選擇：**「免費」**
   - ⚠️ **重要**：即使應用程式是免費的，您仍然可以在應用程式內銷售產品（內購）

5. **聲明**：
   - 勾選「我已閱讀並同意《Google Play 開發者發佈協議》」
   - 勾選「我已閱讀並同意《美國出口法律法規》」（如果適用）

6. 點擊「**建立應用程式**」

#### 2.3 等待應用程式建立

- 系統會顯示「正在建立您的應用程式...」
- 通常幾秒鐘內完成
- 建立完成後，會自動進入應用程式主頁

---

### 步驟 3：設定應用程式內產品

#### 3.1 導航到應用程式內產品

1. 在應用程式主頁的左側導航欄，找到「**營利**」區塊
2. 點擊「**產品**」
3. 點擊「**應用程式內產品**」
4. 如果這是第一次，系統會顯示「尚未建立任何應用程式內產品」

#### 3.2 建立第一個產品：小額代幣包

1. 點擊右上角的「**建立產品**」按鈕
2. 選擇產品類型：
   - **管理式產品**（Managed products）：一次性購買，可重複購買
   - **訂閱**（Subscriptions）：定期付費
   - **選擇「管理式產品」**（因為代幣是消耗性產品）

3. 填寫產品資訊：

   **產品 ID**：
   - 輸入：`token_pack_small`
   - ⚠️ **重要**：產品 ID 必須：
     - 全部小寫
     - 只能包含字母、數字、底線（_）和點（.）
     - 必須唯一（在您的應用程式中）
     - 一旦建立，無法修改
   - 點擊「**建立**」

   **名稱**：
   - 輸入：`小額代幣包`
   - 這是顯示給用戶的名稱
   - 最多 50 個字元

   **描述**：
   - 輸入：`獲得 100 代幣，可用於投票、發起主題等功能`
   - 這是顯示給用戶的描述
   - 最多 80 個字元

   **價格**：
   - 點擊「**設定價格**」
   - 選擇貨幣：`新台幣 (TWD)`
   - 輸入價格：`30`（或您想要的價格）
   - 點擊「**套用**」

   **狀態**：
   - 選擇：**「啟用」**
   - ⚠️ **注意**：只有「啟用」狀態的產品才能在應用程式中購買

4. 點擊右上角的「**儲存**」按鈕

#### 3.3 建立第二個產品：中額代幣包

1. 點擊「**建立產品**」
2. 選擇「**管理式產品**」
3. 填寫資訊：
   - **產品 ID**：`token_pack_medium`
   - **名稱**：`中額代幣包`
   - **描述**：`獲得 500 代幣 + 50 贈送代幣，總共 550 代幣`
   - **價格**：`150` TWD
   - **狀態**：`啟用`
4. 點擊「**儲存**」

#### 3.4 建立第三個產品：大額代幣包

1. 點擊「**建立產品**」
2. 選擇「**管理式產品**」
3. 填寫資訊：
   - **產品 ID**：`token_pack_large`
   - **名稱**：`大額代幣包`
   - **描述**：`獲得 1000 代幣 + 150 贈送代幣，總共 1150 代幣`
   - **價格**：`280` TWD
   - **狀態**：`啟用`
4. 點擊「**儲存**」

#### 3.5 建立第四個產品：超大額代幣包

1. 點擊「**建立產品**」
2. 選擇「**管理式產品**」
3. 填寫資訊：
   - **產品 ID**：`token_pack_xlarge`
   - **名稱**：`超大額代幣包`
   - **描述**：`獲得 3000 代幣 + 500 贈送代幣，總共 3500 代幣`
   - **價格**：`800` TWD
   - **狀態**：`啟用`
4. 點擊「**儲存**」

#### 3.6 驗證產品列表

完成後，您應該在「應用程式內產品」頁面看到 4 個產品：

| 產品 ID | 名稱 | 價格 | 狀態 |
|---------|------|------|------|
| `token_pack_small` | 小額代幣包 | NT$ 30 | 啟用 |
| `token_pack_medium` | 中額代幣包 | NT$ 150 | 啟用 |
| `token_pack_large` | 大額代幣包 | NT$ 280 | 啟用 |
| `token_pack_xlarge` | 超大額代幣包 | NT$ 800 | 啟用 |

---

### 步驟 4：設定測試帳號（可選但建議）

#### 4.1 建立測試帳號

1. 在應用程式主頁，導航到「**設定**」>「**帳號詳細資料**」
2. 在「**授權測試人員**」區塊，點擊「**新增測試人員**」
3. 輸入測試人員的 Google 帳號電子郵件
4. 點擊「**儲存**」

#### 4.2 測試購買流程

1. 在測試設備上，使用測試帳號登入 Google Play
2. 安裝您的應用程式（從內部測試軌道）
3. 在應用程式中測試購買流程
4. 購買不會實際扣款，但會模擬真實購買流程

---

### 步驟 5：上傳應用程式（至少是測試版本）

#### 5.1 準備應用程式

1. 確保應用程式已整合 Google Play Billing Library
2. 確保應用程式使用正確的產品 ID
3. 建立應用程式簽名（如果尚未建立）

#### 5.2 上傳到內部測試軌道

1. 在應用程式主頁，導航到「**發布**」>「**測試**」
2. 選擇「**內部測試**」
3. 點擊「**建立新版本**」
4. 上傳 APK 或 AAB 檔案
5. 填寫版本資訊
6. 點擊「**審查版本**」
7. 點擊「**開始推出到內部測試**」

#### 5.3 邀請測試人員

1. 在「內部測試」頁面，點擊「**測試人員**」標籤
2. 添加測試人員的電子郵件地址
3. 測試人員會收到邀請連結

---

## 🍎 App Store 內購申請流程

### 前置準備

- ✅ Apple ID
- ✅ Apple Developer Program 會員資格（每年 $99 USD）
- ✅ 已建立或準備建立的 iOS App
- ✅ 銀行帳戶資訊（用於收款）

---

### 步驟 1：註冊 Apple Developer Program

#### 1.1 前往 Apple Developer

1. 打開瀏覽器，前往 [Apple Developer](https://developer.apple.com/)
2. 使用您的 Apple ID 登入

#### 1.2 註冊 Apple Developer Program

1. 如果尚未註冊，點擊「**註冊**」或「**Enroll**」
2. 選擇「**Apple Developer Program**」
3. 選擇實體類型：
   - **個人**：個人開發者
   - **組織**：公司或組織
4. 填寫個人或組織資訊
5. 支付年費：**$99 USD**
6. 等待審核（通常 1-2 個工作天）

#### 1.3 驗證帳號

1. 收到確認電子郵件後，點擊確認連結
2. 登入 Apple Developer 帳號
3. 確認會員資格狀態為「**Active**」

---

### 步驟 2：在 App Store Connect 建立應用程式

#### 2.1 前往 App Store Connect

1. 前往 [App Store Connect](https://appstoreconnect.apple.com/)
2. 使用您的 Apple ID 登入

#### 2.2 建立新應用程式

1. 點擊「**我的 App**」
2. 點擊左上角的「**+**」按鈕
3. 選擇「**新 App**」

#### 2.3 填寫應用程式資訊

1. **平台**：
   - 選擇：**「iOS」**

2. **名稱**：
   - 輸入：`ChaosRegistry`
   - 這是在 App Store 中顯示的名稱
   - 必須唯一（在 App Store 中）

3. **主要語言**：
   - 選擇：`繁體中文（台灣）`

4. **套件組合 ID**：
   - 選擇：`com.votechaos.app`
   - 如果尚未建立，需要先在 Apple Developer 中建立 App ID

5. **SKU**：
   - 輸入：`chaos-registry-ios`
   - SKU（Stock Keeping Unit）是應用程式的唯一識別碼
   - 只能包含字母、數字、連字號（-）和底線（_）
   - 一旦建立，無法修改

6. **使用者存取權限**：
   - 選擇：**「完整存取權限」**（一般應用程式）

7. 點擊「**建立**」

#### 2.4 等待應用程式建立

- 系統會顯示「正在建立您的應用程式...」
- 通常幾秒鐘內完成
- 建立完成後，會自動進入應用程式資訊頁面

---

### 步驟 3：建立應用程式內購買項目

#### 3.1 導航到應用程式內購買項目

1. 在應用程式資訊頁面，點擊左側導航欄的「**功能**」
2. 點擊「**App 內購買項目**」
3. 如果這是第一次，系統會顯示「尚未建立任何 App 內購買項目」

#### 3.2 建立第一個產品：小額代幣包

1. 點擊左上角的「**+**」按鈕
2. 選擇產品類型：
   - **消耗性項目**（Consumable）：可重複購買，如遊戲幣
   - **非消耗性項目**（Non-Consumable）：一次購買，永久擁有
   - **自動續訂訂閱**（Auto-Renewable Subscription）：定期自動續訂
   - **非續訂訂閱**（Non-Renewing Subscription）：一次性訂閱，不會自動續訂
   - **選擇「消耗性項目」**（因為代幣是消耗性產品）

3. 填寫產品資訊：

   **參考名稱**：
   - 輸入：`小額代幣包`
   - 這只是內部參考名稱，不會顯示給用戶
   - 可以隨時修改

   **產品 ID**：
   - 輸入：`token_pack_small`
   - ⚠️ **重要**：產品 ID 必須：
     - 全部小寫
     - 只能包含字母、數字、底線（_）和點（.）
     - 必須唯一（在您的應用程式中）
     - 一旦建立，無法修改

   **價格**：
   - 點擊「**價格**」下拉選單
   - 選擇價格等級：
     - **等級 1** = NT$ 30（或您想要的價格等級）
   - ⚠️ **注意**：App Store 使用價格等級系統，不是直接輸入價格
   - 價格等級對應表可以在 App Store Connect 中查看

   **顯示名稱**：
   - 輸入：`小額代幣包`
   - 這是顯示給用戶的名稱
   - 最多 30 個字元

   **描述**：
   - 輸入：`獲得 100 代幣，可用於投票、發起主題等功能`
   - 這是顯示給用戶的描述
   - 最多 45 個字元

4. 點擊右上角的「**儲存**」按鈕

#### 3.3 建立第二個產品：中額代幣包

1. 點擊「**+**」>「**消耗性項目**」
2. 填寫資訊：
   - **參考名稱**：`中額代幣包`
   - **產品 ID**：`token_pack_medium`
   - **價格**：選擇價格等級（例如：**等級 5** = NT$ 150）
   - **顯示名稱**：`中額代幣包`
   - **描述**：`獲得 500 代幣 + 50 贈送代幣，總共 550 代幣`
3. 點擊「**儲存**」

#### 3.4 建立第三個產品：大額代幣包

1. 點擊「**+**」>「**消耗性項目**」
2. 填寫資訊：
   - **參考名稱**：`大額代幣包`
   - **產品 ID**：`token_pack_large`
   - **價格**：選擇價格等級（例如：**等級 10** = NT$ 280）
   - **顯示名稱**：`大額代幣包`
   - **描述**：`獲得 1000 代幣 + 150 贈送代幣，總共 1150 代幣`
3. 點擊「**儲存**」

#### 3.5 建立第四個產品：超大額代幣包

1. 點擊「**+**」>「**消耗性項目**」
2. 填寫資訊：
   - **參考名稱**：`超大額代幣包`
   - **產品 ID**：`token_pack_xlarge`
   - **價格**：選擇價格等級（例如：**等級 20** = NT$ 800）
   - **顯示名稱**：`超大額代幣包`
   - **描述**：`獲得 3000 代幣 + 500 贈送代幣，總共 3500 代幣`
3. 點擊「**儲存**」

#### 3.6 驗證產品列表

完成後，您應該在「App 內購買項目」頁面看到 4 個產品：

| 產品 ID | 顯示名稱 | 價格等級 | 狀態 |
|---------|----------|----------|------|
| `token_pack_small` | 小額代幣包 | 等級 1 (NT$ 30) | 準備提交 |
| `token_pack_medium` | 中額代幣包 | 等級 5 (NT$ 150) | 準備提交 |
| `token_pack_large` | 大額代幣包 | 等級 10 (NT$ 280) | 準備提交 |
| `token_pack_xlarge` | 超大額代幣包 | 等級 20 (NT$ 800) | 準備提交 |

---

### 步驟 4：取得 App Store Shared Secret

#### 4.1 導航到 App 專用共用密鑰

1. 在應用程式資訊頁面，點擊「**功能**」>「**App 內購買項目**」
2. 在頁面頂部，點擊「**App 專用共用密鑰**」連結
3. 或者，在應用程式資訊頁面的「**App 資訊**」區塊，找到「**App 專用共用密鑰**」

#### 4.2 建立或查看 Shared Secret

1. 如果尚未建立，點擊「**產生共用密鑰**」
2. 系統會顯示一個共用密鑰（類似：`a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`）
3. ⚠️ **重要**：立即複製並保存這個密鑰
4. 這個密鑰用於後端驗證 App Store 購買
5. 點擊「**完成**」

---

### 步驟 5：設定沙盒測試帳號

#### 5.1 建立沙盒測試帳號

1. 在 App Store Connect 首頁，點擊「**使用者和存取權限**」
2. 點擊「**沙盒測試人員**」標籤
3. 點擊「**+**」按鈕
4. 填寫測試人員資訊：
   - **名字**：輸入測試人員的名字
   - **姓氏**：輸入測試人員的姓氏
   - **電子郵件**：輸入一個有效的電子郵件地址（不需要是 Apple ID）
   - **密碼**：輸入密碼（至少 8 個字元，包含大小寫字母和數字）
   - **國家或地區**：選擇測試人員的國家或地區
5. 點擊「**儲存**」

#### 5.2 測試購買流程

1. 在測試設備上，**登出 App Store**（設定 > App Store > 登出）
2. 在應用程式中發起購買
3. 系統會提示您使用沙盒測試帳號登入
4. 使用剛才建立的沙盒測試帳號登入
5. 完成購買（不會實際扣款）
6. 驗證代幣是否正確發放

---

## 🔐 申請後續設定

### 步驟 1：在 Supabase 中設定環境變數

#### 1.1 設定 Google Play Service Account

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 建立 Service Account（如果尚未建立）
3. 下載 JSON 金鑰檔案
4. 在 Supabase Dashboard > **Settings** > **Secrets** 中添加：
   - **Key**：`GOOGLE_PLAY_SERVICE_ACCOUNT_EMAIL`
   - **Value**：從 JSON 檔案中複製 `client_email` 的值
5. 添加：
   - **Key**：`GOOGLE_PLAY_PRIVATE_KEY`
   - **Value**：從 JSON 檔案中複製 `private_key` 的值（包含 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`）

#### 1.2 設定 App Store Shared Secret

1. 在 Supabase Dashboard > **Settings** > **Secrets** 中添加：
   - **Key**：`APP_STORE_SHARED_SECRET`
   - **Value**：從 App Store Connect 複製的 Shared Secret

---

### 步驟 2：部署 Edge Functions

```bash
# 部署初始化購買函數
npx supabase functions deploy initiate-purchase

# 部署 Google Play 驗證函數
npx supabase functions deploy verify-google-play-purchase

# 部署 App Store 驗證函數
npx supabase functions deploy verify-app-store-purchase
```

---

## ❓ 常見問題與解決方案

### 問題 1：Google Play 產品 ID 已存在

**錯誤訊息**：`Product ID already exists`

**解決方案**：
- 產品 ID 必須唯一，如果已存在，請使用不同的 ID
- 例如：`token_pack_small_v2` 或 `token_pack_small_001`

### 問題 2：App Store 產品 ID 格式錯誤

**錯誤訊息**：`Invalid product ID format`

**解決方案**：
- 產品 ID 只能包含小寫字母、數字、底線（_）和點（.）
- 不能包含大寫字母、連字號（-）或其他特殊字元

### 問題 3：價格等級對應錯誤

**問題**：不知道 App Store 價格等級對應的實際價格

**解決方案**：
1. 在 App Store Connect 中，點擊價格下拉選單
2. 選擇「**查看價格等級表**」
3. 查看各等級對應的實際價格（會根據貨幣自動轉換）

### 問題 4：測試購買失敗

**問題**：在測試環境中購買失敗

**解決方案**：
- **Android**：確保使用測試帳號登入 Google Play
- **iOS**：確保已登出 App Store，使用沙盒測試帳號
- 確保產品狀態為「啟用」（Android）或「準備提交」（iOS）

### 問題 5：後端驗證失敗

**問題**：購買成功但後端驗證失敗

**解決方案**：
- 檢查 Supabase Secrets 是否正確設定
- 檢查產品 ID 是否與後端代碼中的映射一致
- 檢查 Edge Functions 是否正確部署
- 查看 Edge Functions 日誌以獲取詳細錯誤訊息

---

## ✅ 完成檢查清單

### Google Play

- [ ] Google Play Console 開發者帳號已註冊（$25 USD）
- [ ] 應用程式已建立
- [ ] 4 個應用程式內產品已建立並啟用
- [ ] 產品 ID 與代碼中的映射一致
- [ ] 測試帳號已設定
- [ ] 應用程式已上傳到測試軌道

### App Store

- [ ] Apple Developer Program 會員資格已取得（$99 USD/年）
- [ ] App Store Connect 應用程式已建立
- [ ] 4 個 App 內購買項目已建立
- [ ] 產品 ID 與代碼中的映射一致
- [ ] App Store Shared Secret 已取得
- [ ] 沙盒測試帳號已建立

### 後端設定

- [ ] Google Play Service Account 已設定
- [ ] App Store Shared Secret 已設定
- [ ] Edge Functions 已部署
- [ ] 測試購買流程成功

---

**最後更新**：2025年1月
**適用版本**：Google Play Console 最新版、App Store Connect 最新版

