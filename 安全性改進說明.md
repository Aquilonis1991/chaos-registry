# 🔒 投票系統安全性改進說明

## ⚠️ 原始問題

你提出的安全顧慮非常正確！直接從客戶端更新資料庫確實存在安全風險：
- ❌ 客戶端代碼可以被修改、繞過
- ❌ 可能直接操縱選項票數
- ❌ 可能繞過代幣檢查
- ❌ 可能修改其他用戶的代幣

## ✅ 已實施的安全措施

### 1. **Row Level Security (RLS) - 資料庫層級保護**

Supabase 使用 RLS 政策來限制資料庫操作：

#### Topics 表格
- ✅ **SELECT**: 任何人都可以查看主題（公開）
- ✅ **INSERT**: 只有認證用戶可以建立主題，且 `creator_id` 必須是當前用戶
- ✅ **UPDATE**: **已加強** - 創建者只能更新**非投票相關**的欄位（標題、描述、標籤等）
  - ❌ **禁止直接修改 `options` 欄位**（投票數據）

#### Profiles 表格
- ✅ **SELECT**: 任何人都可以查看基本資料（nickname, avatar）
- ✅ **UPDATE**: 用戶只能更新**自己的**資料
  - 只能修改自己的代幣數量（通過 RLS 驗證）

#### Votes 表格
- ✅ **INSERT**: 用戶只能插入**自己的**投票記錄
  - `user_id` 必須是當前用戶（無法偽造）

#### Free Votes 表格
- ✅ 通過 RLS 保護，只能查看/插入自己的記錄

### 2. **安全資料庫函數 - SECURITY DEFINER**

我創建了兩個安全的資料庫函數（在 `加強投票安全性.sql` 中）：

#### `increment_option_votes()`
- 🔒 使用 `SECURITY DEFINER` - 以更高權限執行
- ✅ **原子操作** - 所有步驟在單一交易中完成
- ✅ **完整驗證**：
  - 檢查用戶是否登入
  - 檢查主題是否存在
  - 檢查主題是否仍活躍
  - 檢查主題是否已結束
  - 檢查選項是否存在
- ✅ **安全更新** - 只能增加票數，不能減少或篡改

#### `increment_free_vote()`
- 🔒 使用 `SECURITY DEFINER`
- ✅ **完整驗證**：
  - 檢查今日是否已使用免費票（防止重複）
  - 檢查主題狀態
  - 檢查選項存在性
- ✅ **自動記錄** - 自動在 `free_votes` 記錄使用情況

### 3. **客戶端代碼改進**

`useVoteOperations.tsx` 現在使用安全函數：

#### 投票流程
1. 嘗試調用 Edge Function（如果有）
2. 如果失敗，**不是直接更新資料庫**
3. 而是調用安全的資料庫函數 `increment_option_votes()`
4. 函數內部完成所有驗證和更新

#### 免費投票流程
1. 嘗試調用 Edge Function
2. 如果失敗，調用 `increment_free_vote()`
3. 函數自動處理所有邏輯（包括檢查是否已使用）

## 🛡️ 安全保護層級

```
客戶端代碼
    ↓
    ├─→ Edge Function（最佳，但有時不可用）
    │
    └─→ 安全資料庫函數（後備方案）
            ↓
        RLS 政策檢查
            ↓
        資料庫層級驗證
            ↓
        原子操作更新
```

## ✅ 現在的安全性

即使客戶端代碼被修改，也無法：
- ❌ 直接修改選項票數（RLS 禁止）
- ❌ 繞過代幣檢查（函數內部驗證）
- ❌ 修改其他用戶的代幣（RLS 限制）
- ❌ 重複使用免費票（函數檢查）
- ❌ 修改已結束的主題（函數驗證）
- ❌ 投票給不存在的選項（函數驗證）

## 📋 執行步驟

### 1. 執行安全性加強 SQL
```sql
-- 在 Supabase SQL Editor 執行
-- 檔案：加強投票安全性.sql
```

這個 SQL 會：
- ✅ 加強 topics 的 UPDATE 政策
- ✅ 創建 `increment_option_votes()` 函數
- ✅ 創建 `increment_free_vote()` 函數

### 2. 重新測試投票功能

執行後，請測試：
- ✅ 代幣投票
- ✅ 免費投票
- ✅ 檢查是否有錯誤

## 🎯 長期建議（選用）

### 最佳實踐：使用 Edge Functions

Edge Functions 提供額外的保護層：
- ✅ 更複雜的業務邏輯
- ✅ 速率限制
- ✅ 更詳細的日誌
- ✅ 防止 API 濫用

**當 Edge Functions 可用時，系統會自動使用它們；不可用時才使用安全函數。**

## 📝 總結

✅ **現在的系統是安全的**，因為：
1. RLS 政策防止未經授權的資料操作
2. 安全函數確保所有驗證都在資料庫層級執行
3. 客戶端只能調用函數，不能直接修改關鍵數據

⚠️ **注意**：仍然建議盡快部署 Edge Functions，因為它們提供額外的保護層和更好的錯誤處理。

