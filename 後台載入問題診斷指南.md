# å¾Œå°è¼‰å…¥å•é¡Œè¨ºæ–·æŒ‡å—

## ğŸ” å•é¡Œæè¿°
å¾Œå°é é¢ä¸€ç›´é¡¯ç¤ºã€Œè®€å–ä¸­ã€ï¼Œç„¡æ³•æ­£å¸¸è¼‰å…¥ã€‚

## ğŸ“‹ è¨ºæ–·æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤
1. æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰
2. æŸ¥çœ‹ **Console** æ¨™ç±¤
3. æŸ¥æ‰¾ä»¥ä¸‹é—œéµå­—ï¼š
   - `[useAdmin]` - ç®¡ç†å“¡ç‹€æ…‹æª¢æŸ¥æ—¥èªŒ
   - `[AdminPage]` - å¾Œå°é é¢æ—¥èªŒ
   - `Error` - ä»»ä½•éŒ¯èª¤è¨Šæ¯
   - `PGRST` - Supabase ç›¸é—œéŒ¯èª¤

### æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ç¶²è·¯è«‹æ±‚
1. æ‰“é–‹ **Network** æ¨™ç±¤
2. ç¯©é¸ `rpc` æˆ– `rest/v1`
3. æŸ¥æ‰¾å° `admin_users` è¡¨çš„æŸ¥è©¢
4. æª¢æŸ¥è«‹æ±‚ç‹€æ…‹ï¼š
   - âœ… 200 - æˆåŠŸ
   - âŒ 400/401/403 - æ¬Šé™å•é¡Œ
   - âŒ 404 - è¡¨æˆ–å‡½æ•¸ä¸å­˜åœ¨
   - âŒ 500 - ä¼ºæœå™¨éŒ¯èª¤

### æ­¥é©Ÿ 3ï¼šåŸ·è¡Œè¨ºæ–· SQL
åŸ·è¡Œ `sql_patches/20251112_diagnose_admin_loading.sql` ä¾†æª¢æŸ¥ï¼š
- `admin_users` è¡¨æ˜¯å¦å­˜åœ¨
- RLS æ”¿ç­–æ˜¯å¦æ­£ç¢º
- ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºç®¡ç†å“¡

### æ­¥é©Ÿ 4ï¼šæª¢æŸ¥ç”¨æˆ¶æ¬Šé™
åœ¨ Supabase Dashboard åŸ·è¡Œ `sql_patches/20251112_diagnose_admin_loading.sql`ï¼š
- æœƒè‡ªå‹•æª¢æŸ¥ç•¶å‰ç™»å…¥ç”¨æˆ¶çš„ç®¡ç†å“¡ç‹€æ…‹
- æœƒåˆ—å‡ºæ‰€æœ‰ç®¡ç†å“¡ç”¨æˆ¶
- æœƒé¡¯ç¤ºç”¨æˆ¶çš„è©³ç´°è³‡è¨Š

### æ­¥é©Ÿ 5ï¼šä¿®å¾© RLS æ”¿ç­–ï¼ˆå¦‚æœéœ€è¦ï¼‰
åŸ·è¡Œ `sql_patches/20251112_fix_admin_users_rls.sql` ä¾†ä¿®å¾© RLS æ”¿ç­–ã€‚

### æ­¥é©Ÿ 6ï¼šå°‡ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
åŸ·è¡Œ `sql_patches/20251112_add_user_as_admin.sql` ä¾†å°‡ç•¶å‰ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡ã€‚

## ğŸ”§ å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### å•é¡Œ 1ï¼š`admin_users` è¡¨ä¸å­˜åœ¨
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```sql
CREATE TABLE IF NOT EXISTS public.admin_users (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  granted_at TIMESTAMPTZ DEFAULT now(),
  granted_by UUID
);

ALTER TABLE public.admin_users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own admin status"
  ON public.admin_users FOR SELECT
  USING (user_id = auth.uid());
```

### å•é¡Œ 2ï¼šRLS æ”¿ç­–é˜»æ­¢æŸ¥è©¢
**æª¢æŸ¥**ï¼š
```sql
SELECT * FROM pg_policies 
WHERE tablename = 'admin_users';
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼šç¢ºä¿æœ‰ä»¥ä¸‹æ”¿ç­–ï¼š
```sql
CREATE POLICY "Users can view own admin status"
  ON public.admin_users FOR SELECT
  USING (user_id = auth.uid());
```

### å•é¡Œ 3ï¼šç”¨æˆ¶ä¸æ˜¯ç®¡ç†å“¡
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
åŸ·è¡Œ `sql_patches/20251112_add_user_as_admin.sql`ï¼š
```sql
-- å°‡ç•¶å‰ç™»å…¥çš„ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡
INSERT INTO public.admin_users (user_id) 
VALUES (auth.uid())
ON CONFLICT (user_id) DO NOTHING
RETURNING user_id, granted_at;
```

### å•é¡Œ 4ï¼šæŸ¥è©¢ä¸€ç›´ pending
**å¯èƒ½åŸå› **ï¼š
- ç¶²è·¯é€£ç·šå•é¡Œ
- Supabase æœå‹™ä¸­æ–·
- RLS æ”¿ç­–è¡çª

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥ Supabase Dashboard çš„ API ç‹€æ…‹
2. æª¢æŸ¥ç€è¦½å™¨ç¶²è·¯é€£ç·š
3. æ¸…é™¤ç€è¦½å™¨å¿«å–å’Œ localStorage
4. é‡æ–°ç™»å…¥

## ğŸ› èª¿è©¦è³‡è¨Š

### å·²æ·»åŠ çš„èª¿è©¦æ—¥èªŒ
ä»£ç¢¼ä¸­å·²æ·»åŠ ä»¥ä¸‹èª¿è©¦æ—¥èªŒï¼š
- `[useAdmin]` - ç®¡ç†å“¡ç‹€æ…‹æª¢æŸ¥éç¨‹
- `[AdminPage]` - å¾Œå°é é¢è¼‰å…¥ç‹€æ…‹

### æª¢æŸ¥æ—¥èªŒè¼¸å‡º
åœ¨ç€è¦½å™¨æ§åˆ¶å°æŸ¥æ‰¾ï¼š
```
[useAdmin] Checking admin status for user: <user-id>
[useAdmin] Admin status result: true/false
[AdminPage] Not admin, redirecting to home
```

## ğŸ“ æ”¹é€²å…§å®¹

### 1. useAdmin Hook æ”¹é€²
- âœ… ä½¿ç”¨ `maybeSingle()` é¿å…æ‰¾ä¸åˆ°è¨˜éŒ„æ™‚å ±éŒ¯
- âœ… æ·»åŠ éŒ¯èª¤è™•ç†å’Œèª¿è©¦æ—¥èªŒ
- âœ… ç­‰å¾… auth è¼‰å…¥å®Œæˆå¾Œå†æŸ¥è©¢
- âœ… æ·»åŠ é‡è©¦æ©Ÿåˆ¶å’Œå¿«å–æ™‚é–“

### 2. AdminPage æ”¹é€²
- âœ… é¡¯ç¤ºæ›´è©³ç´°çš„è¼‰å…¥ç‹€æ…‹
- âœ… é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
- âœ… æ·»åŠ èª¿è©¦æ—¥èªŒ

## ğŸš€ å¿«é€Ÿä¿®å¾©

å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹æŒ‰é †åºåŸ·è¡Œä»¥ä¸‹ SQL è…³æœ¬ï¼š

### 1. è¨ºæ–·å•é¡Œ
åŸ·è¡Œ `sql_patches/20251112_diagnose_admin_loading.sql` ä¾†æª¢æŸ¥å•é¡Œ

### 2. ä¿®å¾© RLS æ”¿ç­–
åŸ·è¡Œ `sql_patches/20251112_fix_admin_users_rls.sql` ä¾†ä¿®å¾© RLS æ”¿ç­–

### 3. å°‡ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡
åŸ·è¡Œ `sql_patches/20251112_add_user_as_admin.sql` ä¾†å°‡ç•¶å‰ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡

**æ³¨æ„**ï¼šæ‰€æœ‰ SQL è…³æœ¬éƒ½æ‡‰è©²åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­åŸ·è¡Œï¼Œé€™æ¨£æ‰èƒ½æ­£ç¢ºä½¿ç”¨ `auth.uid()` å‡½æ•¸ã€‚

## ğŸ“ éœ€è¦æ›´å¤šå¹«åŠ©ï¼Ÿ

å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨ï¼Œè«‹æä¾›ï¼š
1. ç€è¦½å™¨æ§åˆ¶å°çš„å®Œæ•´éŒ¯èª¤è¨Šæ¯
2. Network æ¨™ç±¤ä¸­çš„å¤±æ•—è«‹æ±‚è©³æƒ…
3. è¨ºæ–· SQL çš„åŸ·è¡Œçµæœ

