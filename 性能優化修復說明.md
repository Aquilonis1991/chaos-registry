# 性能優化修復說明

## 🔍 問題分析

從日誌分析，發現以下問題：

### 1. Edge Function 和 RPC 調用超時
- **Edge Function 超時**：15秒後超時
- **RPC 調用超時**：10秒後超時
- **原因**：網絡延遲或數據庫操作太慢

### 2. 配置讀取問題
- **問題**：`ad_reward_amount` 配置不存在，使用默認值 5
- **原因**：應該優先讀取 `mission_watch_ad_reward`，而不是 `ad_reward_amount`
- **影響**：無法使用後台設置的獎勵數量

### 3. 不存在的函數調用
- **問題**：`add_tokens_from_ad_watch` 函數不存在或參數不匹配
- **原因**：函數可能未部署，或參數類型不匹配（需要 `integer`，但傳遞了 `uuid`）

---

## ✅ 已實施的修復

### 1. 優化 Edge Function 配置讀取
**修改文件**：`supabase/functions/watch-ad/index.ts`

**修復內容**：
- **之前**：4次串行查詢（`getSystemConfig` 調用 4 次）
- **現在**：1次並行查詢（一次性讀取所有需要的配置）

**代碼變更**：
```typescript
// 之前：4次串行查詢
const maxAdsPrimary = await getSystemConfig(...);
const MAX_ADS_PER_DAY = maxAdsPrimary !== null ? maxAdsPrimary : await getSystemConfig(...);
const rewardPrimary = await getSystemConfig(...);
const AD_REWARD = rewardPrimary !== null ? rewardPrimary : await getSystemConfig(...);

// 現在：1次並行查詢
const { data: configData } = await supabaseClient
  .from('system_config')
  .select('key, value')
  .in('key', ['mission_watch_ad_limit', 'max_ads_per_day', 'mission_watch_ad_reward', 'ad_reward_amount']);
```

**預期效果**：
- 配置讀取時間從 ~400ms（4次查詢）減少到 ~100ms（1次查詢）
- 總執行時間減少約 300ms

### 2. 縮短超時時間
**修改文件**：`src/hooks/useMissionOperations.tsx`

**修復內容**：
- **Edge Function 超時**：從 15秒 減少到 **8秒**
- **RPC 超時**：從 10秒 減少到 **5秒**

**原因**：
- 如果 Edge Function 或 RPC 超過 8秒/5秒，說明網絡或數據庫有問題
- 快速失敗，避免用戶長時間等待
- 如果 Edge Function 慢，直接使用 RPC 會更快

### 3. 移除不存在的備選方案
**修改文件**：`src/hooks/useMissionOperations.tsx`

**修復內容**：
- 移除 `add_tokens_from_ad_watch` 備選方案
- 原因：函數不存在或參數不匹配（需要 `integer`，但傳遞了 `uuid`）

**代碼變更**：
```typescript
// 之前：嘗試備選方案
catch (timeoutError) {
  try {
    const fallbackResult = await supabase.rpc('add_tokens_from_ad_watch', {...});
    // ...
  } catch (fallbackError) {
    // ...
  }
}

// 現在：直接失敗
catch (timeoutError) {
  throw new Error('RPC 調用超時，請檢查網絡連接或稍後再試');
}
```

### 4. 優化配置讀取日誌
**修改文件**：`src/hooks/useSystemConfigCache.tsx`

**修復內容**：
- 減少不必要的警告日誌
- `ad_reward_amount` 是備選配置，如果 `mission_watch_ad_reward` 存在，不需要警告

---

## 📊 預期性能改善

### 配置讀取優化
- **之前**：4次串行查詢 = ~400ms
- **現在**：1次並行查詢 = ~100ms
- **改善**：減少 300ms（75%）

### 超時優化
- **之前**：Edge Function 15秒 + RPC 10秒 = 最多等待 25秒
- **現在**：Edge Function 8秒 + RPC 5秒 = 最多等待 8秒（如果 Edge Function 超時，直接使用 RPC）
- **改善**：減少 17秒（68%）

### 總體改善
- **第一次觀看**：從 ~7秒 減少到 ~3-5秒
- **後續觀看**：從 ~35秒 減少到 ~3-5秒
- **改善**：減少 80-90%

---

## 🔧 配置讀取邏輯

### 正確的配置鍵名
1. **每日限制**：
   - 優先：`mission_watch_ad_limit`
   - 備選：`max_ads_per_day`
   - 默認：10

2. **獎勵數量**：
   - 優先：`mission_watch_ad_reward`
   - 備選：`ad_reward_amount`
   - 默認：5

### 後台設置建議
在 `system_config` 表中設置：
- `mission_watch_ad_limit` = 30（每日限制）
- `mission_watch_ad_reward` = 5（獎勵數量）

**注意**：不要只設置 `ad_reward_amount`，應該設置 `mission_watch_ad_reward`。

---

## 🚀 下一步操作

### 1. 重新部署 Edge Function
```bash
cd votechaos-main
npx supabase functions deploy watch-ad
```

### 2. 確認後台配置
在 Supabase Dashboard 中檢查 `system_config` 表：
- 確認 `mission_watch_ad_reward` 是否存在
- 如果不存在，創建它：
  ```sql
  INSERT INTO system_config (key, value, category, description)
  VALUES ('mission_watch_ad_reward', 5, 'mission', '觀看廣告獲得的代幣數量');
  ```

### 3. 重新構建並同步
```bash
npm run build
npx cap sync android
```

### 4. 在 Android Studio 中刷新
- 同步 Gradle
- 清理並重新構建
- 重新運行應用

---

## 📝 注意事項

1. **配置緩存**：
   - 配置會在首次加載時緩存
   - 如果修改了後台配置，需要重新啟動應用或等待緩存過期

2. **超時設置**：
   - 如果網絡很慢，8秒/5秒可能仍然超時
   - 可以根據實際情況調整超時時間

3. **錯誤處理**：
   - 如果 Edge Function 和 RPC 都超時，會顯示錯誤訊息
   - 用戶可以稍後再試

---

## 🧪 測試檢查清單

完成修復後，請測試：

- [ ] 配置讀取正確（使用後台設置的 `mission_watch_ad_reward`）
- [ ] Edge Function 在 8 秒內完成（或超時後使用 RPC）
- [ ] RPC 在 5 秒內完成
- [ ] 第一次觀看廣告：響應時間 < 5 秒
- [ ] 第二次觀看廣告：響應時間 < 5 秒
- [ ] 第三次觀看廣告：響應時間 < 5 秒
- [ ] 不會出現越來越慢的情況
- [ ] Toast 訊息只顯示一次（不重複）

---

## 🔍 如果問題仍然存在

如果完成上述步驟後，問題仍然存在，請檢查：

1. **Edge Function 是否已重新部署**
   - 檢查 Supabase Dashboard → Edge Functions → watch-ad
   - 確認最新部署時間

2. **後台配置是否正確**
   - 檢查 `system_config` 表中的 `mission_watch_ad_reward` 是否存在
   - 確認值是否正確

3. **網絡連接**
   - 檢查設備網絡連接
   - 確認 Supabase 服務是否正常

4. **查看詳細日誌**
   - 在 Android Studio 的 Logcat 中查看詳細日誌
   - 確認 Edge Function 和 RPC 的實際執行時間


