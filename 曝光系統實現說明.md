# 曝光系統完整實現說明

## 📋 概述

曝光系統允許用戶在建立主題時選擇曝光方案，排序直接依 `topics.exposure_level` 計算權重。若需要更高等級，可透過補差額的方式升級（僅允許低等 → 高等）。

## 🗄️ 資料庫結構

### 1. `exposure_applications` 表
記錄曝光升級行為（用於限制與冷卻判斷），包含：
- `topic_id`: 主題ID
- `user_id`: 申請用戶ID
- `exposure_level`: 曝光等級（normal/medium/high）
- `price`: 價格（代幣數）
- `status`: 狀態（active/expired/cancelled）
- `expires_at`: 曝光結束時間

### 2. `exposure_limits` 表
系統配置表，管理曝光限制：
- `daily_limit`: 每日申請上限
- `daily_global_limit`: 全平台每日曝光名額限制
- `max_concurrent`: 同時最多曝光主題數
- `min_votes_required`: 最低投票門檻
- `cooldown_hours`: 冷卻時間
- `price`: 價格
- `sort_weight_multiplier`: 排序權重倍數
- `top_duration_minutes`: 熱門榜置頂時間

### 3. `user_exposure_stats` 表
追蹤用戶每日申請次數（每日重置）

### 4. `exposure_violations` 表
記錄違規行為，用於處罰機制

## 🔧 SQL 函數

### 核心函數

1. **`can_apply_exposure(p_user_id, p_exposure_level, p_topic_id)`**
   - 檢查是否可以升級曝光（僅允許低等轉高等）
   - 會計算需補的代幣差額、檢查投票數 / 冷卻 / 數量限制

2. **`apply_exposure(p_topic_id, p_exposure_level)`**
   - 扣除差額代幣並更新 `topics.exposure_level`
   - 記錄升級行為於 `exposure_applications`、`user_exposure_stats`

3. **`get_hot_topics_with_exposure(p_limit, p_offset)`**
   - 獲取熱門主題列表（含曝光排序）
   - 優先顯示有曝光的主題

4. **`get_latest_topics_with_exposure(p_limit, p_offset)`**
   - 獲取最新主題列表（含曝光插隊）

5. **`reset_daily_exposure_stats()`**
   - 每日重置曝光統計（應在 00:00 執行）

7. **`check_exposure_violations()`**
   - 檢查並記錄曝光違規

## 📱 前端組件

### 1. `TopicCard` 組件
- 顯示熱門火焰標示與基本資訊（曝光標章已移除）

### 2. `ExposureApplyDialog` 組件
- 曝光升級對話框（僅顯示比目前更高的方案）
- 直接告知需補的代幣差額
- 檢查用戶資格（代幣、投票數、限制等）
- 升級成功後即更新主題的曝光等級

### 3. `HomePage` 更新
- 熱門列表頂部顯示「推廣主題區」（預設 30 筆，可由 `home_promoted_limit` 調整）
- 使用新的 SQL 函數獲取排序後的主題，推廣主題不會重複出現在一般列表

### 4. `VoteDetailPage` 更新
- 僅創建者且目前等級非最高時才顯示「升級曝光」按鈕
- 整合 `ExposureApplyDialog` 傳入目前曝光等級

## 🎯 排序邏輯

### 熱門排序
```
排序公式：曝光權重 × 0.6 + 投票數 × 0.3 + 時間衰減 × 0.1
```

### 最新排序
```
按時間排序，但給付費用戶插隊權
```

### 曝光分數計算
```sql
exposure_score = (base_popularity × 0.5) + (vote_count × 0.3) + (exposure_level_weight × 0.2) − (time_decay_hours × 0.02)
```

其中：
- 普通曝光權重：1.2
- 中等曝光權重：1.6
- 高度曝光權重：2.2

## ⚙️ 曝光方案設定

### 普通曝光
- 價格：30 代幣
- 排序加權：+20%
- 置頂時間：30 分鐘
- 每日申請上限：5 次
- 同時最多曝光主題：2 個
- 最低投票門檻：20 票

### 中等曝光
- 價格：90 代幣
- 排序加權：+60%
- 置頂時間：1 小時
- 每日申請上限：3 次
- 同時最多曝光主題：2 個
- 最低投票門檻：20 票

### 高度曝光
- 價格：180 代幣
- 排序加權：+120%
- 置頂時間：2 小時
- 每日申請上限：1 次
- 同時最多曝光主題：2 個
- 最低投票門檻：20 票
- 冷卻時間：12 小時

## 🛡️ 防止洗榜規則

1. 每位用戶最多同時擁有 2 個曝光中主題
2. 曝光期間若投票數未達 20 票，下次申請需等待 12 小時冷卻期
3. 若違反規則或疑似洗榜，系統會自動暫停曝光資格 24 小時

## 🔄 定時任務

### 每日重置（00:00 執行）

執行以下 SQL：
```sql
SELECT public.reset_daily_exposure_stats();
SELECT public.expire_old_exposure_applications();
SELECT public.check_exposure_violations();
```

### 設定 Supabase Cron Job

在 Supabase Dashboard > Database > Cron Jobs 中設定：

```sql
-- 每日 00:00 (UTC+8 = 16:00 UTC) 執行
SELECT cron.schedule(
  'reset-exposure-stats',
  '0 16 * * *', -- 每天 UTC 16:00 (台北時間 00:00)
  $$
  SELECT public.reset_daily_exposure_stats();
  SELECT public.expire_old_exposure_applications();
  SELECT public.check_exposure_violations();
  $$
);
```

## 📝 使用流程

### 用戶升級曝光

1. 進入主題詳情頁（僅創建者可見，且目前等級非最高）
2. 點擊「升級曝光」按鈕
3. 選擇想升級的等級（僅顯示更高的方案）
4. 系統自動檢查：
   - 需補的差額代幣是否足夠
   - 投票數門檻
   - 每日/全站申請次數（額滿時提示「今日曝光額滿，請明日再試」）
   - 冷卻與違規狀態
5. 確認後扣除差額並更新 `topics.exposure_level`

### 管理員管理曝光

可在後台管理系統中：
- 查看所有曝光申請
- 透過「首頁配置」調整推廣數量與曝光名額
- 處理違規行為

## 🚀 部署步驟

1. **執行 SQL 腳本**
   ```bash
   # 在 Supabase SQL Editor 中執行
   votechaos-main/sql_patches/20251113_create_exposure_system.sql
   ```

2. **設定定時任務**
   - 在 Supabase Dashboard 中設定 Cron Job
   - 或使用外部定時任務服務

3. **驗證功能**
   - 測試曝光申請流程
   - 驗證排序邏輯
   - 檢查限制規則

## 📊 系統配置管理

- 「首頁配置」：
  - `home_promoted_limit`：推廣主題區一次顯示的主題數量
  - `home_exposure_global_limit_normal`：普通曝光每日全平台名額（0 代表無上限）
  - `home_exposure_global_limit_medium`：中等曝光每日全平台名額
  - `home_exposure_global_limit_high`：高度曝光每日全平台名額
- 「驗證限制」：
  - `exposure_normal_daily_limit`：普通曝光每日申請上限（每用戶）
  - `exposure_medium_daily_limit`：中等曝光每日申請上限
  - `exposure_high_daily_limit`：高度曝光每日申請上限
  - `exposure_max_concurrent`：同時最多曝光主題數
  - `exposure_min_votes`：最低投票門檻

## ⚠️ 注意事項

1. **時區設定**：確保定時任務使用正確的時區（台北時間 UTC+8）
2. **性能優化**：曝光排序函數已建立索引，但大量主題時可能需要優化
3. **代幣扣除**：使用原子操作確保代幣扣除的準確性
4. **違規處理**：系統會自動檢查違規，但管理員應定期審查

## 🔍 故障排除

### 曝光申請失敗

檢查：
1. 用戶代幣餘額
2. 主題投票數是否達到門檻
3. 每日申請次數是否超限
4. 是否在冷卻期間
5. 是否在處罰期間

### 排序不正確

檢查：
1. `topics.exposure_level` 是否已更新為正確等級
2. SQL 函數是否已重新部署 (`get_topic_exposure_score`, `get_hot_topics_with_exposure`)
3. 是否有快取尚未刷新（重新整理 Supabase schema cache / 前端資料）

### 定時任務未執行

檢查：
1. Cron Job 是否正確設定
2. 時區設定是否正確
3. Supabase 日誌中是否有錯誤

## 📚 相關檔案

- SQL 腳本：`votechaos-main/sql_patches/20251113_create_exposure_system.sql`
- 調整腳本：`votechaos-main/sql_patches/20251120_update_exposure_logic.sql`
- 前端組件：`votechaos-main/src/components/ExposureApplyDialog.tsx`
- 主題卡片：`votechaos-main/src/components/TopicCard.tsx`
- 首頁：`votechaos-main/src/pages/HomePage.tsx`
- 主題詳情頁：`votechaos-main/src/pages/VoteDetailPage.tsx`
- Topics Hook：`votechaos-main/src/hooks/useTopics.tsx`

