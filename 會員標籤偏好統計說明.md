# 會員標籤偏好統計方案

## 功能總覽

- **標籤正規化**：所有主題標籤會自動寫入 `topic_tag_entries`，保留原始文字與標準化結果。
- **偏好統計**：`user_tag_preferences` 會記錄每位會員在各標籤的投票次數、投入代幣與最後投票時間。
- **即時同步**：當主題標籤或投票異動時，觸發器會自動重新計算相關會員的偏好。
- **API 取得資料**：新增 `get_user_tag_preferences` RPC，可供前台或後台查詢偏好資訊。

## 資料流程

1. 會員建立/編輯主題時輸入的標籤會照舊存放在 `topics.tags`。
2. 觸發器 `sync_topic_tag_entries_*` 會將標籤寫入 `topic_tag_entries`，內容包含：
   - `raw_tag`：原始輸入、顯示使用
   - `normalized_tag`：經 unaccent、lower、空白轉 `-` 後的標籤，用於統計
3. 會員投票 (`votes`) 後，`refresh_user_tag_preferences_on_votes` 觸發器會呼叫 `refresh_user_tag_preferences`：
   - 統計該會員 × 標籤的投票次數、代幣總額（取 `votes.amount`）、最後投票時間
   - 寫入 `user_tag_preferences` 表，方便查詢與導出
4. 若主題標籤被修改，`refresh_user_tag_preferences_on_topics` 會找出所有對該主題投票過的會員並重新統計。

## RPC：get_user_tag_preferences

```sql
SELECT * FROM public.get_user_tag_preferences(); -- 當前會員
SELECT * FROM public.get_user_tag_preferences('USER_UUID'); -- 僅限管理員
```

回傳欄位：
| 欄位 | 說明 |
|------|------|
| `normalized_tag` | 標準化後的標籤 key |
| `display_tag` | 代表性原始標籤（供 UI 顯示） |
| `vote_count` | 投票次數 |
| `token_amount` | 投入代幣總額 |
| `last_voted_at` | 最近一次投票時間 |

## 前端使用

提供 `useUserTagPreferences` hook（`src/hooks/useUserTagPreferences.ts`）：

```ts
const { preferences, loading, refresh } = useUserTagPreferences(); // 目前登入者
// 或
const adminView = useUserTagPreferences(targetUserId);
```

- 會自動呼叫 `get_user_tag_preferences`。
- 發生錯誤時會在 Console 與 toast 顯示。

## 導出與應用

- 直接查詢 `user_tag_preferences` 或 RPC 的結果即可得到會員偏好列表。
- 資料已經過標準化，可方便分群、推薦或匯出販售。
- 若需要更多屬性，可在 `user_tag_preferences` 表中再加入分數、曝光等欄位。

## 後續擴充建議

1. **批次報表**：建立 Materialized View 或 ETL，定期將偏好資料匯出至外部倉儲。
2. **自訂權重**：調整統計公式（例：近期投票加權、代幣金額作為信心值）。
3. **事件追蹤**：若未來要追蹤頁面瀏覽、收藏，可沿用 `normalized_tag` 當作關聯 key。*** End Patch

