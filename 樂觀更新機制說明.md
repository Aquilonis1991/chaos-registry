# 樂觀更新機制說明與潛在問題

## ⚠️ 重要提醒
**以下優化項目請在專案幾乎完成後再進行，目前優先完成核心功能**

## 當前實現

### 更新時機
- **改進前**：在觀看廣告**之前**就進行樂觀更新
- **改進後**：在廣告觀看**成功後**才進行樂觀更新

### 工作流程
1. 用戶點擊「觀看廣告」按鈕
2. 檢查每日限制（在觀看前）
3. 顯示廣告並等待用戶完成觀看
4. **廣告觀看成功後** → 立即樂觀更新 UI（代幣 +5）
5. 調用 Edge Function 或 RPC 增加代幣
6. 實時訂閱自動同步服務器數據（權威來源）

## 潛在的使用者體驗問題

### 1. **數據不一致風險** ⚠️
**問題**：
- 如果服務器操作失敗，但 UI 已經更新，會導致數據不一致
- 用戶看到代幣增加了，但實際上沒有獲得

**解決方案**：
- ✅ 在廣告觀看成功後才進行樂觀更新（已實現）
- ✅ 如果操作失敗，自動回滾樂觀更新（已實現）
- ✅ 實時訂閱會用服務器的權威數據覆蓋樂觀更新

### 2. **重複更新問題** ⚠️
**問題**：
- 樂觀更新 + 實時訂閱可能導致代幣被更新兩次
- 例如：樂觀更新 +5，實時訂閱又 +5，導致代幣多增加了

**解決方案**：
- ✅ 實時訂閱會**覆蓋**樂觀更新，而不是累加（已實現）
- ✅ 實時訂閱的數據是權威來源，確保最終一致性

### 3. **時序衝突問題** ⚠️
**問題**：
- 樂觀更新 → 服務器更新 → 實時訂閱更新
- 如果實時訂閱在錯誤處理之前就更新了，回滾可能會導致代幣減少

**解決方案**：
- ✅ 實時訂閱會用服務器的正確數據覆蓋任何樂觀更新
- ✅ 如果服務器操作失敗，實時訂閱不會觸發，樂觀更新會被回滾

### 4. **網絡中斷問題** ⚠️
**問題**：
- 如果網絡中斷，樂觀更新會顯示錯誤的數據
- 用戶可能看到代幣增加了，但實際上沒有同步到服務器

**解決方案**：
- ✅ 實時訂閱會在網絡恢復時自動同步
- ✅ 如果服務器操作失敗，會自動回滾樂觀更新
- ⚠️ **建議**：可以添加網絡狀態檢測，在離線時禁用樂觀更新

### 5. **用戶重複操作** ⚠️
**問題**：
- 用戶看到代幣增加了，可能會再次點擊按鈕
- 如果第一次操作還在進行中，可能導致重複請求

**解決方案**：
- ✅ 使用 `isWatchingAd` 狀態防止重複點擊（已實現）
- ✅ 按鈕在操作進行中會被禁用

## 改進建議

### 1. 添加網絡狀態檢測
```typescript
// 在離線時禁用樂觀更新，避免數據不一致
if (!navigator.onLine) {
  // 不進行樂觀更新，等待網絡恢復
}
```

### 2. 添加超時保護
```typescript
// 如果實時訂閱在 5 秒內沒有觸發，手動刷新 profile
setTimeout(() => {
  if (!profileUpdated) {
    refreshProfile();
  }
}, 5000);
```

### 3. 添加視覺反饋
```typescript
// 在樂觀更新時顯示「同步中...」提示
// 讓用戶知道數據正在同步
```

## 當前實現的優勢

1. ✅ **即時反饋**：用戶立即看到代幣增加，體驗流暢
2. ✅ **自動同步**：實時訂閱確保最終一致性
3. ✅ **錯誤處理**：失敗時自動回滾，避免數據不一致
4. ✅ **性能優化**：減少不必要的網絡請求

## 監控建議

建議在生產環境中監控以下指標：
1. 樂觀更新與實時訂閱的時間差
2. 樂觀更新回滾的頻率
3. 實時訂閱的延遲時間
4. 用戶重複操作的頻率

