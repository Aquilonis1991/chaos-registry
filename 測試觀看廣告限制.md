# 🧪 測試觀看廣告次數限制是否生效

## 📋 測試前準備

### 步驟 1：確認後台配置已設置

1. 前往 Supabase Dashboard → 你的專案
2. 進入 **系統配置管理**（或直接在 SQL Editor 中查詢）

**檢查配置是否存在**：
```sql
-- 查詢觀看廣告相關配置
SELECT 
  key,
  value,
  description,
  updated_at
FROM public.system_config
WHERE key IN ('max_ads_per_day', 'mission_watch_ad_limit', 'ad_reward_amount', 'mission_watch_ad_reward')
ORDER BY key;
```

**如果沒有配置，請添加**：
```sql
-- 添加每日觀看廣告限制（例如：20次）
INSERT INTO public.system_config (key, value, category, description)
VALUES 
  ('max_ads_per_day', '20', 'mission', '每日觀看廣告次數上限')
ON CONFLICT (key) 
DO UPDATE SET 
  value = EXCLUDED.value,
  updated_at = now();

-- 添加觀看廣告獎勵（例如：5代幣）
INSERT INTO public.system_config (key, value, category, description)
VALUES 
  ('ad_reward_amount', '5', 'mission', '觀看廣告獎勵代幣數量')
ON CONFLICT (key) 
DO UPDATE SET 
  value = EXCLUDED.value,
  updated_at = now();
```

### 步驟 2：確認 SQL 函數已更新

```sql
-- 檢查 add_tokens_from_ad_watch 函數是否從 system_config 讀取配置
SELECT 
  proname as function_name,
  pg_get_functiondef(oid) as function_definition
FROM pg_proc
WHERE proname = 'add_tokens_from_ad_watch'
  AND pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public');
```

確認函數定義中包含：
- `SELECT value INTO v_config_value FROM public.system_config WHERE key = 'max_ads_per_day'`
- 或 `WHERE key = 'mission_watch_ad_limit'`

如果沒有，請執行：`sql_patches/20251123_update_ad_watch_limit_from_config.sql`

---

## 🧪 測試步驟

### 測試 1：檢查當前觀看次數

```sql
-- 查看當前用戶的觀看次數和最後登入時間
SELECT 
  id,
  nickname,
  tokens,
  ad_watch_count,
  last_login,
  CASE 
    WHEN last_login::date = CURRENT_DATE THEN ad_watch_count
    ELSE 0
  END as today_watch_count
FROM public.profiles
WHERE id = auth.uid(); -- 替換為你的用戶 ID
```

### 測試 2：在 App 中測試觀看廣告

1. **打開 App**（Android Studio 或網頁版）
2. **前往任務頁面**（Mission Page）
3. **點擊「觀看廣告」按鈕**
4. **觀看完廣告後**，觀察：
   - ✅ 是否成功獲得代幣
   - ✅ 右上角代幣數量是否立即更新
   - ✅ 是否顯示成功訊息

### 測試 3：驗證限制是否生效

**方法 A：通過 App 測試**

1. **連續觀看廣告**，直到達到限制
2. **預期行為**：
   - 前 N 次（N = 你設置的 `max_ads_per_day`）應該成功
   - 第 N+1 次應該顯示錯誤：「今日觀看廣告次數已達上限」
   - 錯誤訊息中應該顯示正確的限制數量

**方法 B：通過數據庫驗證**

```sql
-- 查看觀看記錄
SELECT 
  user_id,
  amount,
  transaction_type,
  description,
  created_at
FROM public.token_transactions
WHERE user_id = auth.uid() -- 替換為你的用戶 ID
  AND transaction_type = 'watch_ad'
  AND created_at::date = CURRENT_DATE
ORDER BY created_at DESC;

-- 查看當前觀看次數
SELECT 
  ad_watch_count,
  last_login,
  CASE 
    WHEN last_login::date = CURRENT_DATE THEN ad_watch_count
    ELSE 0
  END as today_watch_count
FROM public.profiles
WHERE id = auth.uid(); -- 替換為你的用戶 ID
```

### 測試 4：驗證配置變更是否生效

1. **修改後台配置**：
   ```sql
   -- 將限制改為 5 次（用於快速測試）
   UPDATE public.system_config
   SET value = '5', updated_at = now()
   WHERE key = 'max_ads_per_day';
   ```

2. **等待幾秒鐘**（讓配置生效）

3. **重置測試用戶的觀看次數**（可選）：
   ```sql
   -- 重置觀看次數（僅用於測試）
   UPDATE public.profiles
   SET ad_watch_count = 0
   WHERE id = auth.uid(); -- 替換為你的用戶 ID
   ```

4. **再次測試觀看廣告**：
   - 應該在第 6 次時顯示「已達上限」
   - 限制數量應該是 5

---

## 🔍 調試和驗證

### 檢查 Edge Function 日誌

1. 前往 Supabase Dashboard → **Edge Functions** → `watch-ad`
2. 點擊 **Logs** 標籤
3. 查看最近的日誌，確認：
   - ✅ 函數被調用
   - ✅ 配置讀取成功（應該看到 `MAX_ADS_PER_DAY` 的值）
   - ✅ 沒有錯誤訊息

### 檢查前端日誌

在 Android Studio 的 Logcat 中，搜索：
- `[watchAd]` - 查看觀看廣告的流程
- `[useProfile]` - 查看代幣更新
- `getSystemConfig` - 查看配置讀取

### 驗證配置讀取

```sql
-- 測試 Edge Function 是否能讀取配置
-- 注意：這需要在 Edge Function 中執行，但可以通過日誌驗證

-- 或者直接查詢配置值
SELECT 
  key,
  value,
  jsonb_typeof(value) as value_type
FROM public.system_config
WHERE key IN ('max_ads_per_day', 'mission_watch_ad_limit');
```

---

## ✅ 成功標準

測試通過的標準：

1. ✅ **配置讀取**：Edge Function 能從 `system_config` 讀取 `max_ads_per_day`
2. ✅ **限制生效**：達到限制次數後，無法再觀看廣告
3. ✅ **錯誤訊息正確**：顯示的限制數量與後台配置一致
4. ✅ **代幣更新**：觀看成功後，代幣數量正確增加
5. ✅ **配置變更生效**：修改後台配置後，限制立即生效（無需重啟）

---

## 🐛 常見問題排查

### 問題 1：限制沒有生效，仍然可以無限觀看

**檢查**：
1. ✅ 確認 SQL 函數已更新（執行了 `20251123_update_ad_watch_limit_from_config.sql`）
2. ✅ 確認 Edge Function 已部署最新版本
3. ✅ 確認後台配置中有 `max_ads_per_day` 或 `mission_watch_ad_limit`
4. ✅ 檢查 Edge Function 日誌，確認配置讀取成功

### 問題 2：限制數量不正確

**檢查**：
1. ✅ 確認後台配置的值是正確的數字
2. ✅ 確認配置的 key 名稱正確（`max_ads_per_day` 或 `mission_watch_ad_limit`）
3. ✅ 檢查配置值的類型（應該是數字，不是字符串）

### 問題 3：修改配置後沒有生效

**解決方案**：
1. 等待幾秒鐘（配置可能需要時間同步）
2. 清除 App 緩存或重新啟動 App
3. 確認配置已正確保存到數據庫

---

## 📝 測試檢查清單

- [ ] 後台配置中已設置 `max_ads_per_day` 或 `mission_watch_ad_limit`
- [ ] SQL 函數 `add_tokens_from_ad_watch` 已更新
- [ ] Edge Function `watch-ad` 已部署
- [ ] 測試觀看廣告功能正常
- [ ] 達到限制後無法再觀看
- [ ] 錯誤訊息顯示正確的限制數量
- [ ] 修改配置後限制立即生效
- [ ] 代幣數量正確更新

完成所有檢查後，觀看廣告次數限制就應該正常工作了！

