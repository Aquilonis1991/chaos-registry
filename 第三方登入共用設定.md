# 第三方登入共用設定指南（Discord → Google → LINE → Facebook → Apple）

> **適用範圍**：僅 App（iOS / Android），無 Web 版  
> **實作階段**：僅處理「共用設定」，平台差異（SHA、URL Scheme、entitlements 等）在 Part 10 之後進行。

---

## Part 0：決定全域共用規格（iOS + Android）

### 0-1. 統一 Callback URL

- **HTTPS 回調（供 OAuth 平台 / Supabase 使用）**  
  `https://epyykzxxglkjombvozhr.supabase.co/auth/v1/callback`

- **App Deep Link 回調（供 iOS/Android App 使用）** ✅ 已實作  
  自訂 Scheme：`votechaos`  
  回調網址：`votechaos://auth/callback` ✅

> 後續五個 Provider（Discord / Google / LINE / Facebook / Apple）都要註冊這兩條回調。

---

## Part 1：Supabase Authentication 共用設定

1. 進入 **Supabase → Authentication → URL Configuration**
2. **Site URL**：填寫正式站 `https://chaos-registry.vercel.app`
   - 供郵件與 OAuth 預設導回使用。
3. **Additional Redirect URLs**：加入 `votechaos://auth/callback` ✅
   - 未來若有其他 landing page，可在此追加。
4. 此處是 Supabase 允許的返回網址清單，必須包含程式碼中要用到的 `redirectTo`。
   - ✅ 前端程式碼已更新，App 版會使用 `votechaos://auth/callback`

---

## Part 2：Supabase Providers 共用底稿

位置：**Authentication → Providers**

1. 尋找以下 provider：Discord、Google、Line、Facebook、Apple。
2. 先全部 Enable，即使 Client ID / Secret 未填也可以。
3. 確認每個 provider 的回調 URL 為 `https://<PROJECT_REF>.supabase.co/auth/v1/callback`。

---

## Part 3：Discord

### 3-1. Discord Developer Portal
1. 進入 [Discord Developer Portal](https://discord.com/developers/applications)
2. 建立 Application → 左側 **OAuth2 → General**：
   - Redirects 加入：
     - `https://epyykzxxglkjombvozhr.supabase.co/auth/v1/callback`
     - `votechaos://auth/callback` ✅ 已實作
   - 記下 **Client ID**、**Client Secret**
   - **您的 Application ID**：`1444352797418979458`
   - **您的 Client Secret**：`OnVMwX382G4zfwNBobV34udRE17132KA`

### 3-2. 填入 Supabase
- Supabase → Authentication → Providers → Discord  
  - Client ID：貼剛才的 Client ID  
  - Secret：貼 Client Secret  
  - Save ✅

---

## Part 4：Google（僅共用部分）

### 4-1. Google Cloud Console
1. 建立或選擇專案
2. **APIs & Services → OAuth consent screen**
   - User type：External
   - 填 App 名稱、支援 Email、隱私權政策 URL（可先填 App Store 用的）
3. **Credentials → Create Credentials → OAuth client ID**
   - Application type：Web application
   - Authorized redirect URIs：
     - `https://<PROJECT_REF>.supabase.co/auth/v1/callback`
4. 記下 **Client ID**、**Client Secret**

> Android / iOS 平台差異（SHA、Bundle ID）稍後處理。

### 4-2. 填入 Supabase
- Supabase → Authentication → Providers → Google  
  - Client ID：貼 Client ID  
  - Client Secret：貼 Client Secret  
  - Scopes：預設 `openid email profile`  
  - Save ✅

---

## Part 5：LINE（共用設定）

### 5-1. LINE Developers Console
1. 進入 [LINE Developers](https://developers.line.biz/)  
2. 建 Provider（例如 ChaosRegistry）
3. 在該 Provider 建立 Channel（類型：LINE Login）
4. 記下 **Channel ID**、**Channel Secret**

### 5-2. Callback URL
- LINE Channel → LINE Login 設定  
  - Callback URL 加入：
    - `https://<PROJECT_REF>.supabase.co/auth/v1/callback`
    - `votechaos://auth/callback`（若僅允許一條，先填 HTTPS，App Deep Link 可在程式指定）

### 5-3. 填入 Supabase
- Supabase → Authentication → Providers → Line  
  - Channel ID：貼 Channel ID  
  - Channel Secret：貼 Channel Secret  
  - Save ✅

> 若需取得 Email，另行申請 LINE 的 Email 權限。先完成基本登入即可。

---

## Part 6：Facebook

### 6-1. Meta for Developers
1. 到 [Meta for Developers](https://developers.facebook.com/) 建 App → 類型選 Consumer
2. **Settings → Basic**：填 App 名稱、聯絡 Email、隱私權政策 URL  
3. 記下 **App ID**、**App Secret**

### 6-2. Facebook Login 設定
1. Products → Add product → Facebook Login → Set up
2. Facebook Login → Settings → Valid OAuth Redirect URIs：
   - `https://<PROJECT_REF>.supabase.co/auth/v1/callback`
   - `votechaos://auth/callback`
3. 開發期間可維持「開發模式」，上線前記得切換為 Live。

### 6-3. 填入 Supabase
- Supabase → Authentication → Providers → Facebook  
  - App ID：貼 App ID  
  - App Secret：貼 App Secret  
  - Save ✅

> 切 Live 時 Facebook 會檢查隱私政策 URL，務必可存取。

---

## Part 7：Apple（Sign in with Apple）

> 僅 iOS 會用，但 Supabase 角度屬於共用設定，先打底。

### 7-1. 先備妥
- 付費 Apple Developer Program 帳號  
- Team ID（在 Apple Developer / App Store Connect 可查）

### 7-2. 建 Key 與 Service ID
1. Apple Developer → Certificates, IDs & Profiles
2. 左側 **Keys**：
   - 建立新 Key → 勾選「Sign in with Apple」→ 命名 → 下載 `.p8`（僅一次）
   - 記下 **Key ID**
3. 左側 **Identifiers → Service IDs**：
   - 建立 Service ID（例：`com.yourbrand.votechaos.signin`)
   - 啟用 Sign in with Apple
   - Return URLs：
     - `https://<PROJECT_REF>.supabase.co/auth/v1/callback`
     - `votechaos://auth/callback`

### 7-3. 填入 Supabase
- Supabase → Authentication → Providers → Apple  
  - Team ID：填 Team ID  
  - Client ID：填 Service ID（例 `com.yourbrand.votechaos.signin`）  
  - Key ID：填 Key ID  
  - Private Key：貼 `.p8` 全文（含 BEGIN/END）
  - Save ✅

---

## Part 8：App 端共用程式碼（Flutter 範例）

```dart
import 'package:supabase_flutter/supabase_flutter.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Supabase.initialize(
    url: 'https://<PROJECT_REF>.supabase.co',
    anonKey: '<YOUR_ANON_KEY>',
  );

  runApp(const MyApp());
}

final supa = Supabase.instance.client;

Future<void> signInWithProvider(OAuthProviderType provider) async {
  await supa.auth.signInWithOAuth(
    provider,
    redirectTo: 'votechaos://auth/callback', // 共用 Deep Link
  );
}
```

呼叫方式：

```dart
await signInWithProvider(Provider.discord);
await signInWithProvider(Provider.google);
await signInWithProvider(Provider.line);
await signInWithProvider(Provider.facebook);
await signInWithProvider(Provider.apple); // 建議只在 iOS 顯示按鈕
```

> 只要 iOS / Android 都完成 `<APP_SCHEME>://auth/callback` 的 Deep Link 接收，這段程式碼即可通用。

---

## Part 9：目前已完成項目

- ✅ 定義共用 Site URL / Redirect URL  
- ✅ Supabase 允許 `https://epyykzxxglkjombvozhr.supabase.co/auth/v1/callback` 與 `votechaos://auth/callback`  
- ✅ 五個 provider 後台都登記同一組 callback、並填入 Client ID / Secret（Apple：Team ID + Service ID + Key）  
- ✅ App 端擁有可重用的 `signInWithOAuth` 流程

---

## Part 10：平台差異設定（已完成 ✅）

> ✅ **Deep Link 設定已完成**（2025-01-29）

- **Android 專屬** ✅
  - ✅ `AndroidManifest.xml` 已增加 `<intent-filter>` 接收 `votechaos://auth/callback`  
  - ⏳ Google Sign-In 需要填 SHA-1 / SHA-256（keytool 指令） - 僅 Google 登入需要
  - ⏳ 若使用原生 SDK，需處理各 provider 的 dependency 與 Activity Result - 目前使用 Supabase OAuth，不需要

- **iOS 專屬** ✅
  - ✅ `Info.plist` 已添加 URL Types，Scheme 為 `votechaos`  
  - ✅ `AppDelegate.swift` 已實作 URL 處理（透過 ApplicationDelegateProxy）
  - ⏳ Apple Sign-In 原生 UI（`sign_in_with_apple` 套件）、entitlements - 可選
  - ⏳ App Transport Security / Universal Links 需求 - 可選

- **前端程式碼** ✅
  - ✅ `AuthPage.tsx` 已更新，App 版使用 `votechaos://auth/callback`，Web 版使用 HTTPS URL
  - ✅ `app-lifecycle.ts` 已更新，可處理 OAuth 回調

**詳細設定請參考**：[DeepLink設定完成報告.md](./DeepLink設定完成報告.md)

---

**版本**：2025-11-27  
**作者**：AI 助手（依使用者需求生成）  
**備註**：僅涵蓋「共用設定」，不含 Web / 平台差異細節。

