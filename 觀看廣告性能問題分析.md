# 觀看廣告功能性能問題分析

## 問題描述

觀看廣告功能越執行，後續的觀看動作越緩慢。

### 觀察到的延遲

從日誌分析：
- **第一次觀看**：廣告關閉 13:18:21 → Edge Function 成功 13:18:28（**7秒**）
- **第二次觀看**：廣告關閉 13:19:59 → Edge Function 成功 13:20:34（**35秒**）

延遲從 7 秒增加到 35 秒，增加了 **5 倍**。

---

## 問題原因分析

### 1. Edge Function 沒有超時設置 ⚠️
**問題**：
- 當前 Edge Function 調用沒有超時限制
- 如果 Edge Function 內部操作變慢，會一直等待
- 隨著時間推移，可能累積未完成的請求

**影響**：
- 用戶體驗差（長時間等待）
- 可能導致資源洩漏

### 2. Edge Function 內部操作串行執行 ⚠️
**問題**：
Edge Function 內部有多個串行操作：
1. 讀取配置（2次查詢 `getSystemConfig`）
2. 讀取 profile
3. 調用 RPC `add_tokens`
4. 更新 profile（`ad_watch_count`, `last_login`）
5. 插入 `token_transactions`
6. 插入 `audit_logs`

**影響**：
- 每個操作都要等待前一個完成
- 總延遲 = 所有操作延遲的總和
- 隨著數據庫負載增加，延遲會累積

### 3. 可能的資源洩漏 ⚠️
**問題**：
- Edge Function 可能沒有正確關閉數據庫連接
- 可能有未清理的監聽器或訂閱
- 可能有未完成的 Promise 累積

**影響**：
- 隨著時間推移，資源消耗增加
- 導致後續操作變慢

### 4. 數據庫連接池問題 ⚠️
**問題**：
- 如果 Edge Function 沒有正確釋放連接
- 連接池可能耗盡
- 新請求需要等待可用連接

**影響**：
- 後續請求延遲增加
- 可能導致超時錯誤

---

## 修復策略

### 策略 1：為 Edge Function 調用添加超時（推薦）
**優點**：
- 快速失敗，避免長時間等待
- 可以回退到 RPC 備選方案
- 改善用戶體驗

**實現**：
```typescript
// 在 useMissionOperations.tsx 中
const edgeFunctionPromise = supabase.functions.invoke('watch-ad', {
  body: {}
});

const timeoutPromise = new Promise<{ data: null; error: { message: string } }>((_, reject) => 
  setTimeout(() => reject(new Error('Edge Function 調用超時（15秒）')), 15000)
);

const { data: edgeData, error: edgeError } = await Promise.race([
  edgeFunctionPromise,
  timeoutPromise
]) as { data: any; error: any };
```

### 策略 2：優化 Edge Function 內部操作
**優點**：
- 減少總執行時間
- 提高並發處理能力

**實現**：
```typescript
// 在 watch-ad/index.ts 中
// 1. 並行讀取配置
const [maxAdsConfig, rewardConfig] = await Promise.all([
  getSystemConfig(supabaseClient, 'max_ads_per_day', 10),
  getSystemConfig(supabaseClient, 'ad_reward_amount', 5)
]);

// 2. 並行執行非依賴操作
await Promise.all([
  // 更新 profile
  supabaseClient.from('profiles').update({...}),
  // 插入交易記錄
  supabaseClient.from('token_transactions').insert({...}),
  // 插入審計日誌（可選，不阻塞）
  supabaseClient.from('audit_logs').insert({...}).catch(() => {})
]);
```

### 策略 3：添加連接池管理
**優點**：
- 確保資源正確釋放
- 避免連接洩漏

**實現**：
- 在 Edge Function 中確保所有操作完成後正確關閉連接
- 使用 try-finally 確保資源清理

### 策略 4：添加重試機制
**優點**：
- 處理臨時性錯誤
- 提高成功率

**實現**：
```typescript
// 添加指數退避重試
const retryWithBackoff = async (fn: () => Promise<any>, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
    }
  }
};
```

---

## 建議的修復方案

### 優先級 1：立即修復（必須）
1. **為 Edge Function 調用添加超時**（15秒）
2. **確保錯誤處理正確**，失敗時回退到 RPC

### 優先級 2：性能優化（建議）
1. **優化 Edge Function 內部操作**（並行化）
2. **減少不必要的數據庫查詢**（緩存配置）

### 優先級 3：長期優化（可選）
1. **添加連接池監控**
2. **添加性能指標追蹤**
3. **優化數據庫索引**

---

## 預期效果

實施修復後：
- **Edge Function 超時**：最多等待 15 秒，然後回退到 RPC
- **並行操作**：總執行時間減少 30-50%
- **用戶體驗**：響應時間更穩定，不會無限等待

---

## 注意事項

1. **測試**：修復後需要充分測試，確保所有場景正常
2. **監控**：建議添加性能監控，追蹤 Edge Function 執行時間
3. **回退**：確保 RPC 備選方案可靠，作為安全網

---

## 相關文件

- `src/hooks/useMissionOperations.tsx` - 觀看廣告邏輯
- `supabase/functions/watch-ad/index.ts` - Edge Function 實現
- `src/lib/admob.ts` - AdMob 封裝


