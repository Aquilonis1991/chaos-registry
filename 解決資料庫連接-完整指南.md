# 🔧 解決資料庫連接問題 - 完整指南

## ✅ 第一步：確認環境變數已正確設定

### 當前 `.env.local` 內容：
```env
# Supabase 配置
VITE_SUPABASE_URL=https://epyykzxxglkjombvozhr.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVweXlrenh4Z2xram9tYnZvemhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MDg1MTEsImV4cCI6MjA3NTk4NDUxMX0.A2QBfDwW1TlG5GiKaHN3_JzT3Tk3U0hJfTZm0hRq1tg
```

✅ **環境變數已正確設定！**
- Project ID: `epyykzxxglkjombvozhr`
- API Key 格式正確

---

## ✅ 第二步：重啟開發伺服器

### 操作步驟：

1. **在終端機中按 Ctrl+C** 停止當前運行的 `npm run dev`
2. **等待完全停止**
3. **重新執行**：
```bash
npm run dev
```
4. **等待伺服器啟動**，應該會顯示：
```
  VITE v5.x.x  ready in xxx ms

  ➜  Local:   http://localhost:8080/
  ➜  Network: use --host to expose
```

---

## ✅ 第三步：驗證連接

### 在瀏覽器中驗證：

1. **打開** http://localhost:8080/
2. **按 F12** 打開開發者工具
3. **Console 標籤** 中輸入：
```javascript
import.meta.env.VITE_SUPABASE_URL
```
4. **應該顯示**：
```
"https://epyykzxxglkjombvozhr.supabase.co"
```

✅ **如果顯示正確**，環境變數已生效！  
❌ **如果還是顯示舊的**，請重新執行步驟 2

---

## ✅ 第四步：初始化資料庫

### 在 Supabase Dashboard 執行：

1. **前往** https://supabase.com/dashboard
2. **選擇** Project ID 為 `epyykzxxglkjombvozhr` 的專案
3. **左側選單** → **SQL Editor**
4. **點擊** "New Query"
5. **打開專案中的** `00-完整資料庫架構.sql` 檔案
6. **複製全部內容**（約 600 行）
7. **貼到 SQL Editor**
8. **點擊右上角** "Run" 或按 **Ctrl+Enter**

### 預期結果：
執行成功後，最下方應該顯示：
```sql
status: "✅ Database schema initialized successfully!"
table_count: 4+
config_count: 14
```

---

## ✅ 第五步：驗證資料庫

### 檢查表格是否建立成功：

1. **在 Supabase Dashboard**
2. **左側選單** → **Table Editor**
3. **應該看到以下表格**：
   - ✅ `profiles`
   - ✅ `topics`
   - ✅ `votes`
   - ✅ `system_config`
   - 以及其他表格...

### 檢查系統配置：

1. **點擊** `system_config` 表格
2. **應該看到 14 條記錄**，包含：
   - title_max_length
   - vote_button_amounts
   - exposure_costs
   - 等等...

---

## ✅ 第六步：測試建立主題

### 在應用中測試：

1. **回到瀏覽器** http://localhost:8080/
2. **如果沒有登入，先登入或註冊**
3. **點擊** "建立主題" 或 "+"
4. **填寫主題資訊**：
   - 標題：測試主題
   - 說明：這是測試
   - 選項：選項A、選項B
   - 類別：科技
   - 標籤：測試
5. **點擊** "確認建立"

### 預期結果：
- ✅ 顯示 "主題建立成功"
- ✅ 跳轉到主題詳情頁
- ✅ 可以看到剛建立的主題

---

## 🔍 故障排查

### 問題 1：環境變數沒生效

**症狀**：Console 還是顯示舊的 Project ID

**解決方法**：
1. 確認 `.env.local` 檔案在專案根目錄
2. 確認檔案名稱是 `.env.local` 不是 `env.local`
3. **完全關閉終端機**，重新開啟
4. 重新執行 `npm run dev`

---

### 問題 2：SQL 執行失敗

**症狀**：執行 SQL 時出現錯誤

**可能原因**：
- 表格已存在
- 權限不足
- SQL 語法錯誤

**解決方法**：
1. 先刪除已存在的表格（如果有）
2. 重新執行 SQL
3. 查看錯誤訊息，逐步排查

---

### 問題 3：建立主題失敗

**症狀**：點擊建立後出現錯誤

**可能原因**：
- 資料庫未初始化完整
- Edge Functions 未部署
- CORS 問題

**檢查步驟**：
1. **按 F12** 查看 Console 錯誤訊息
2. **查看** Network 標籤，看請求是否成功
3. **確認** 資料庫所有表格都已建立

---

## 📋 完整檢查清單

執行完成後，請確認：

- [ ] `.env.local` 檔案內容正確
- [ ] 開發伺服器已重啟
- [ ] Console 顯示正確的 Project URL
- [ ] Supabase Dashboard 可以看到所有表格
- [ ] `system_config` 表有 14 條記錄
- [ ] 可以成功建立測試主題
- [ ] 可以看到主題列表
- [ ] 可以對主題投票

全部打勾 ✅ 表示資料庫連接問題已解決！

---

## 🎯 下一步

資料庫連接問題解決後，可以：

1. ✅ 測試所有現有功能
2. ✅ 開始實現缺失功能
3. ✅ 進行完整的功能驗證

---

## 🆘 需要幫助？

如果遇到問題，請提供：
1. Console 中的錯誤訊息（截圖或文字）
2. Network 標籤中失敗的請求詳情
3. Supabase SQL Editor 的錯誤訊息

我會幫您進一步診斷！

