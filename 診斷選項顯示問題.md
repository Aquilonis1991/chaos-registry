# 🔍 診斷主題選項顯示問題

## 🎯 需要的資訊

請提供以下資訊幫助我診斷：

### 1. 錯誤訊息詳情
- Console 顯示什麼錯誤？
- 錯誤發生在哪一行？
- 完整的錯誤堆疊是什麼？

### 2. 選項顯示問題
- **沒有顯示選項**？
- **選項文字顯示錯誤**？
- **選項票數顯示錯誤**？
- **選項重複顯示**？
- **其他問題**？

---

## 🔍 可能的問題

### 問題 1：options 資料結構錯誤

**症狀**：選項不顯示或顯示錯誤

**檢查方法**：
在 Supabase Dashboard：
1. **Table Editor** → **topics**
2. **找到您建立的主題**
3. **查看 options 欄位**

**正確的格式**：
```json
[
  {
    "id": "uuid-1",
    "text": "選項A",
    "votes": 0
  },
  {
    "id": "uuid-2",
    "text": "選項B",
    "votes": 0
  }
]
```

**如果格式錯誤**，執行修復 SQL：
```sql
-- 查看問題主題的 options
SELECT id, title, options FROM public.topics;

-- 修復特定主題的 options（替換 TOPIC_ID）
UPDATE public.topics
SET options = jsonb_build_array(
  jsonb_build_object('id', gen_random_uuid()::text, 'text', '選項A', 'votes', 0),
  jsonb_build_object('id', gen_random_uuid()::text, 'text', '選項B', 'votes', 0)
)
WHERE id = 'TOPIC_ID';
```

---

### 問題 2：options 是 null 或空陣列

**症狀**：沒有顯示任何選項

**檢查 Console**：
```javascript
// 應該看到類似的錯誤
Cannot read properties of null
```

**修復方法**：
```sql
-- 設定預設 options
UPDATE public.topics
SET options = '[]'::jsonb
WHERE options IS NULL;
```

---

### 問題 3：option.id 不存在

**症狀**：Console 顯示 `option.id is undefined`

**原因**：建立主題時沒有為每個選項生成 id

**修復方法**：
```sql
-- 為所有 options 添加 id
UPDATE public.topics
SET options = (
  SELECT jsonb_agg(
    option || jsonb_build_object('id', gen_random_uuid()::text)
  )
  FROM jsonb_array_elements(options) AS option
  WHERE NOT (option ? 'id')
);
```

---

### 問題 4：選項重複顯示（相同 key）

**症狀**：Console 顯示
```
Warning: Encountered two children with the same key
```

**原因**：選項沒有唯一的 id

**修復方法**：同問題 3

---

## 🛠️ 通用修復 SQL

如果不確定問題，執行這個通用修復：

```sql
-- 修復所有主題的 options 結構
UPDATE public.topics
SET options = (
  SELECT jsonb_agg(
    CASE 
      -- 如果已有 id, text, votes，保持不變
      WHEN (option ? 'id') AND (option ? 'text') AND (option ? 'votes') 
        THEN option
      -- 如果缺少 id
      WHEN NOT (option ? 'id')
        THEN option || jsonb_build_object('id', gen_random_uuid()::text)
      -- 如果缺少 votes
      WHEN NOT (option ? 'votes')
        THEN option || jsonb_build_object('votes', 0)
      ELSE option
    END
  )
  FROM jsonb_array_elements(options) AS option
)
WHERE options IS NOT NULL AND jsonb_array_length(options) > 0;

-- 重新載入 schema
NOTIFY pgrst, 'reload schema';
```

---

## 📋 診斷步驟

### 步驟 1：檢查 Console
1. F12 → Console
2. 重新整理頁面
3. 複製所有錯誤訊息

### 步驟 2：檢查 Network
1. F12 → Network
2. 找到 topics 的請求
3. 查看 Response 中的 options 資料

### 步驟 3：檢查資料庫
1. Supabase Dashboard → Table Editor → topics
2. 查看 options 欄位的實際內容
3. 確認格式是否正確

---

## 🎯 請提供

請告訴我：
1. **具體的錯誤訊息**（Console 中的）
2. **選項顯示的問題**（什麼地方顯示錯誤）
3. **截圖**（如果可能）

或者，直接執行上面的「通用修復 SQL」試試看！

---

**等待您的回覆以精確診斷問題！** 🔍


