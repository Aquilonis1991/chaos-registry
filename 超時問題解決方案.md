# Edge Function å’Œ RPC è¶…æ™‚å•é¡Œè§£æ±ºæ–¹æ¡ˆ

## ğŸ” å•é¡Œåˆ†æ

å¾æ—¥èªŒåˆ†æï¼Œç™¼ç¾ä»¥ä¸‹å•é¡Œï¼š

### è§€å¯Ÿåˆ°çš„è¶…æ™‚
- **Edge Function è¶…æ™‚**ï¼š8 ç§’å¾Œè¶…æ™‚ï¼ˆå·²èª¿æ•´ç‚º 20 ç§’ï¼‰
- **RPC èª¿ç”¨è¶…æ™‚**ï¼š5 ç§’å¾Œè¶…æ™‚ï¼ˆå·²èª¿æ•´ç‚º 15 ç§’ï¼‰
- **æœ€çµ‚çµæœ**ï¼šå…©å€‹éƒ½è¶…æ™‚ï¼Œå°è‡´è§€çœ‹å»£å‘Šå¤±æ•—

### å¯èƒ½çš„åŸå› 

1. **Edge Function æœªé‡æ–°éƒ¨ç½²** âš ï¸ **æœ€å¯èƒ½**
   - å¦‚æœ Edge Function æ²’æœ‰é‡æ–°éƒ¨ç½²ï¼Œä»ç„¶ä½¿ç”¨èˆŠä»£ç¢¼ï¼ˆ4æ¬¡ä¸²è¡ŒæŸ¥è©¢ï¼‰
   - èˆŠä»£ç¢¼åŸ·è¡Œæ™‚é–“é•·ï¼Œå®¹æ˜“è¶…æ™‚

2. **ç¶²çµ¡é€£æ¥å•é¡Œ**
   - è¨­å‚™ç¶²çµ¡é€£æ¥ä¸ç©©å®š
   - Supabase æœå‹™éŸ¿æ‡‰æ…¢

3. **æ•¸æ“šåº«éŸ¿æ‡‰æ…¢**
   - æ•¸æ“šåº«è² è¼‰é«˜
   - æŸ¥è©¢åŸ·è¡Œæ™‚é–“é•·

---

## âœ… å·²å¯¦æ–½çš„ä¿®å¾©

### 1. å¢åŠ è¶…æ™‚æ™‚é–“
- **Edge Function**ï¼šå¾ 8 ç§’å¢åŠ åˆ° **20 ç§’**
- **RPC**ï¼šå¾ 5 ç§’å¢åŠ åˆ° **15 ç§’**

**åŸå› **ï¼š
- çµ¦è¶³å¤ æ™‚é–“è®“ Edge Function å’Œ RPC å®Œæˆ
- å¦‚æœç¶²çµ¡æ…¢ï¼Œ20 ç§’æ‡‰è©²è¶³å¤ 

### 2. æ”¹å–„éŒ¯èª¤è¨Šæ¯
- æ·»åŠ æ›´è©³ç´°çš„éŒ¯èª¤æç¤º
- å€åˆ†è¶…æ™‚éŒ¯èª¤å’Œå…¶ä»–éŒ¯èª¤
- æä¾›ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤è¨Šæ¯

---

## ğŸš€ å¿…é ˆåŸ·è¡Œçš„æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šé‡æ–°éƒ¨ç½² Edge Functionï¼ˆ**æœ€é‡è¦**ï¼‰

é€™æ˜¯**æœ€é—œéµ**çš„æ­¥é©Ÿã€‚å¦‚æœ Edge Function æ²’æœ‰é‡æ–°éƒ¨ç½²ï¼Œä»ç„¶ä½¿ç”¨èˆŠä»£ç¢¼ï¼ˆ4æ¬¡ä¸²è¡ŒæŸ¥è©¢ï¼‰ï¼Œæœƒå°è‡´è¶…æ™‚ã€‚

#### æ–¹æ³• Aï¼šä½¿ç”¨ Supabase CLI

```powershell
cd C:\Users\USER\Documents\Mywork\votechaos-main

# 1. ç¢ºèªå·²ç™»å…¥
supabase login

# 2. é€£æ¥å°ˆæ¡ˆï¼ˆå¦‚æœé‚„æ²’é€£æ¥ï¼‰
supabase link --project-ref idfqzcsxvuxperxfieam

# 3. éƒ¨ç½² watch-ad Edge Function
supabase functions deploy watch-ad
```

#### æ–¹æ³• Bï¼šä½¿ç”¨ Supabase Dashboard

1. å‰å¾€ï¼šhttps://supabase.com/dashboard
2. é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ
3. å·¦å´é¸å–® â†’ **Edge Functions**
4. æ‰¾åˆ° `watch-ad` å‡½æ•¸ä¸¦é»æ“Š
5. è¤‡è£½ `votechaos-main\supabase\functions\watch-ad\index.ts` çš„å…§å®¹
6. è²¼ä¸Šåˆ° Dashboard ç·¨è¼¯å™¨
7. é»æ“Š **Deploy** æŒ‰éˆ•

**è©³ç´°æ­¥é©Ÿ**ï¼šè«‹åƒè€ƒ `é‡æ–°éƒ¨ç½²watch-ad Edge Functionè©³ç´°æ­¥é©Ÿ.md`

### æ­¥é©Ÿ 2ï¼šç¢ºèªå¾Œå°é…ç½®

åœ¨ Supabase Dashboard ä¸­æª¢æŸ¥ `system_config` è¡¨ï¼š

1. ç¢ºèª `mission_watch_ad_reward` æ˜¯å¦å­˜åœ¨
2. å¦‚æœä¸å­˜åœ¨ï¼Œå‰µå»ºå®ƒï¼š
   ```sql
   INSERT INTO system_config (key, value, category, description)
   VALUES ('mission_watch_ad_reward', 5, 'mission', 'è§€çœ‹å»£å‘Šç²å¾—çš„ä»£å¹£æ•¸é‡');
   ```

### æ­¥é©Ÿ 3ï¼šé‡æ–°æ§‹å»ºä¸¦åŒæ­¥ï¼ˆå·²å®Œæˆï¼‰

```powershell
npm run build
npx cap sync android
```

### æ­¥é©Ÿ 4ï¼šåœ¨ Android Studio ä¸­åˆ·æ–°

1. åŒæ­¥ Gradleï¼šé»æ“Š ğŸ”„ Sync Project with Gradle Files
2. æ¸…ç†ä¸¦é‡æ–°æ§‹å»ºï¼š`Build` â†’ `Clean Project` â†’ `Rebuild Project`
3. é‡æ–°é‹è¡Œæ‡‰ç”¨

---

## ğŸ” é©—è­‰éƒ¨ç½²æ˜¯å¦æˆåŠŸ

### æ–¹æ³• 1ï¼šæª¢æŸ¥ Dashboard

1. å‰å¾€ Supabase Dashboard â†’ Edge Functions â†’ watch-ad
2. æŸ¥çœ‹ **Last updated** æ™‚é–“
3. ç¢ºèªæ™‚é–“æ˜¯å‰›æ‰éƒ¨ç½²çš„æ™‚é–“

### æ–¹æ³• 2ï¼šæŸ¥çœ‹å‡½æ•¸ä»£ç¢¼

åœ¨ Dashboard ä¸­æŸ¥çœ‹ `watch-ad` å‡½æ•¸çš„ä»£ç¢¼ï¼Œç¢ºèªï¼š
- é…ç½®è®€å–ä½¿ç”¨ **1æ¬¡ä¸¦è¡ŒæŸ¥è©¢**ï¼ˆä¸æ˜¯ 4 æ¬¡ä¸²è¡ŒæŸ¥è©¢ï¼‰
- ä»£ç¢¼åŒ…å«ä»¥ä¸‹å…§å®¹ï¼š
  ```typescript
  // å¾ system_config è®€å–é…ç½®ï¼ˆä¸€æ¬¡æ€§è®€å–æ‰€æœ‰éœ€è¦çš„é…ç½®ï¼Œé¿å…å¤šæ¬¡æŸ¥è©¢ï¼‰
  const { data: configData, error: configError } = await supabaseClient
    .from('system_config')
    .select('key, value')
    .in('key', ['mission_watch_ad_limit', 'max_ads_per_day', 'mission_watch_ad_reward', 'ad_reward_amount']);
  ```

---

## ğŸ“Š é æœŸæ”¹å–„

éƒ¨ç½²æˆåŠŸå¾Œï¼Œæ‚¨æ‡‰è©²çœ‹åˆ°ï¼š

1. **é…ç½®è®€å–å„ªåŒ–**ï¼š
   - Edge Function å…§éƒ¨é…ç½®è®€å–å¾ 4 æ¬¡æŸ¥è©¢æ¸›å°‘åˆ° 1 æ¬¡
   - é…ç½®è®€å–æ™‚é–“å¾ ~400ms æ¸›å°‘åˆ° ~100ms

2. **éŸ¿æ‡‰æ™‚é–“æ”¹å–„**ï¼š
   - Edge Function åœ¨ 20 ç§’å…§å®Œæˆï¼ˆæˆ–è¶…æ™‚å¾Œä½¿ç”¨ RPCï¼‰
   - RPC åœ¨ 15 ç§’å…§å®Œæˆ
   - ç¸½éŸ¿æ‡‰æ™‚é–“ï¼š< 20 ç§’ï¼ˆå¦‚æœ Edge Function æˆåŠŸï¼‰æˆ– < 35 ç§’ï¼ˆå¦‚æœä½¿ç”¨ RPCï¼‰

3. **éŒ¯èª¤è™•ç†æ”¹å–„**ï¼š
   - è¶…æ™‚éŒ¯èª¤é¡¯ç¤ºæ›´è©³ç´°çš„æç¤º
   - ç”¨æˆ¶çŸ¥é“æ˜¯ç¶²çµ¡å•é¡Œï¼Œå¯ä»¥ç¨å¾Œå†è©¦

---

## âš ï¸ å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨

å¦‚æœå®Œæˆä¸Šè¿°æ­¥é©Ÿå¾Œï¼Œå•é¡Œä»ç„¶å­˜åœ¨ï¼Œè«‹æª¢æŸ¥ï¼š

### 1. Edge Function æ˜¯å¦å·²é‡æ–°éƒ¨ç½²
- æª¢æŸ¥ Supabase Dashboard â†’ Edge Functions â†’ watch-ad
- ç¢ºèª **Last updated** æ™‚é–“æ˜¯æœ€æ–°çš„
- ç¢ºèªä»£ç¢¼å·²æ›´æ–°ï¼ˆä½¿ç”¨ 1 æ¬¡ä¸¦è¡ŒæŸ¥è©¢ï¼‰

### 2. ç¶²çµ¡é€£æ¥
- æª¢æŸ¥è¨­å‚™ç¶²çµ¡é€£æ¥
- ç¢ºèª Supabase æœå‹™æ˜¯å¦æ­£å¸¸
- å˜—è©¦ä½¿ç”¨å…¶ä»–ç¶²çµ¡ï¼ˆWiFi/ç§»å‹•æ•¸æ“šï¼‰

### 3. æ•¸æ“šåº«æ€§èƒ½
- æª¢æŸ¥ Supabase Dashboard â†’ Database â†’ Performance
- ç¢ºèªæ•¸æ“šåº«éŸ¿æ‡‰æ™‚é–“æ­£å¸¸
- æª¢æŸ¥æ˜¯å¦æœ‰é•·æ™‚é–“é‹è¡Œçš„æŸ¥è©¢

### 4. æŸ¥çœ‹è©³ç´°æ—¥èªŒ
- åœ¨ Android Studio çš„ Logcat ä¸­æŸ¥çœ‹è©³ç´°æ—¥èªŒ
- ç¢ºèª Edge Function å’Œ RPC çš„å¯¦éš›åŸ·è¡Œæ™‚é–“
- æŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–éŒ¯èª¤è¨Šæ¯

---

## ğŸ“ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

å®Œæˆä¿®å¾©å¾Œï¼Œè«‹æ¸¬è©¦ï¼š

- [ ] Edge Function å·²é‡æ–°éƒ¨ç½²ï¼ˆDashboard é¡¯ç¤ºæœ€æ–°æ™‚é–“ï¼‰
- [ ] é…ç½®è®€å–æ­£ç¢ºï¼ˆä½¿ç”¨å¾Œå°è¨­ç½®çš„ `mission_watch_ad_reward`ï¼‰
- [ ] Edge Function åœ¨ 20 ç§’å…§å®Œæˆï¼ˆæˆ–è¶…æ™‚å¾Œä½¿ç”¨ RPCï¼‰
- [ ] RPC åœ¨ 15 ç§’å…§å®Œæˆ
- [ ] ç¬¬ä¸€æ¬¡è§€çœ‹å»£å‘Šï¼šéŸ¿æ‡‰æ™‚é–“ < 20 ç§’
- [ ] ç¬¬äºŒæ¬¡è§€çœ‹å»£å‘Šï¼šéŸ¿æ‡‰æ™‚é–“ < 20 ç§’
- [ ] ä¸æœƒå‡ºç¾è¶…æ™‚éŒ¯èª¤
- [ ] å¦‚æœè¶…æ™‚ï¼Œé¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤è¨Šæ¯

---

## ğŸ”— ç›¸é—œæ–‡æª”

- [é‡æ–°éƒ¨ç½²watch-ad Edge Functionè©³ç´°æ­¥é©Ÿ.md](./é‡æ–°éƒ¨ç½²watch-ad Edge Functionè©³ç´°æ­¥é©Ÿ.md)
- [æ€§èƒ½å„ªåŒ–ä¿®å¾©èªªæ˜.md](./æ€§èƒ½å„ªåŒ–ä¿®å¾©èªªæ˜.md)
- [åˆ·æ–°Androidå°ˆæ¡ˆæµç¨‹.md](./åˆ·æ–°Androidå°ˆæ¡ˆæµç¨‹.md)


