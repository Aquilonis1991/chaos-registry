# ✅ 驗證觀看廣告配置是否生效

## 📊 當前配置狀態

根據你的配置查詢結果：
- ✅ **每日觀看限制**：30 次（`mission_watch_ad_limit`）
- ✅ **每次觀看獎勵**：10 代幣（`mission_watch_ad_reward`）

## 🧪 快速測試步驟

### 測試 1：檢查當前觀看次數

在 Supabase SQL Editor 中執行：

```sql
-- 查看當前用戶的觀看次數（替換為你的用戶 ID）
SELECT 
  id,
  nickname,
  tokens,
  ad_watch_count,
  last_login,
  CASE 
    WHEN last_login::date = CURRENT_DATE THEN ad_watch_count
    ELSE 0
  END as today_watch_count,
  CASE 
    WHEN last_login::date = CURRENT_DATE AND ad_watch_count >= 30 THEN '已達上限'
    WHEN last_login::date = CURRENT_DATE THEN CONCAT('還可觀看 ', 30 - ad_watch_count, ' 次')
    ELSE '今日尚未觀看'
  END as status
FROM public.profiles
WHERE id = auth.uid(); -- 或直接替換為你的用戶 ID
```

### 測試 2：在 App 中測試

1. **打開 App**（Android Studio）
2. **前往任務頁面**
3. **觀看廣告**，確認：
   - ✅ 成功獲得 **10 代幣**（不是 5 代幣）
   - ✅ 右上角代幣數量立即更新
   - ✅ 顯示成功訊息

### 測試 3：驗證限制是否生效

**快速測試方法**（臨時降低限制）：

```sql
-- 臨時將限制改為 3 次（用於快速測試）
UPDATE public.system_config
SET value = '3', updated_at = now()
WHERE key = 'mission_watch_ad_limit';

-- 重置你的觀看次數（僅用於測試，替換為你的用戶 ID）
UPDATE public.profiles
SET ad_watch_count = 0
WHERE id = 'YOUR_USER_ID';
```

然後在 App 中：
- 觀看第 1、2、3 次：應該成功，每次獲得 10 代幣
- 觀看第 4 次：應該顯示「今日觀看廣告次數已達上限（最多可觀看 3 次）」

**測試完成後，恢復原配置**：

```sql
-- 恢復為 30 次
UPDATE public.system_config
SET value = '30', updated_at = now()
WHERE key = 'mission_watch_ad_limit';
```

### 測試 4：檢查 Edge Function 是否讀取配置

1. **前往 Supabase Dashboard** → **Edge Functions** → `watch-ad`
2. **點擊 Logs 標籤**
3. **觀看一次廣告**
4. **查看日誌**，應該看到：
   - 函數被調用
   - 沒有錯誤訊息
   - 如果配置讀取成功，應該在日誌中看到相關信息

### 測試 5：驗證代幣獎勵數量

```sql
-- 查看最近的觀看記錄
SELECT 
  created_at,
  amount,
  description,
  CASE 
    WHEN amount = 10 THEN '✅ 獎勵正確（10 代幣）'
    ELSE CONCAT('❌ 獎勵錯誤（應該是 10，實際是 ', amount, '）')
  END as reward_status
FROM public.token_transactions
WHERE transaction_type = 'watch_ad'
  AND created_at::date = CURRENT_DATE
ORDER BY created_at DESC
LIMIT 5;
```

---

## 🔍 驗證配置讀取邏輯

根據代碼邏輯，系統會按以下順序讀取配置：

### 觀看限制：
1. 優先：`max_ads_per_day`
2. 備選：`mission_watch_ad_limit` ← **你當前使用的配置**

### 獎勵數量：
1. 優先：`ad_reward_amount`
2. 備選：`mission_watch_ad_reward` ← **你當前使用的配置**

**當前狀態**：系統會使用 `mission_watch_ad_limit`（30 次）和 `mission_watch_ad_reward`（10 代幣）

---

## ✅ 成功標準

測試通過的標準：

1. ✅ **觀看成功**：每次觀看獲得 10 代幣（不是 5 代幣）
2. ✅ **限制生效**：觀看 30 次後，第 31 次顯示「已達上限」
3. ✅ **錯誤訊息正確**：顯示「最多可觀看 30 次」
4. ✅ **代幣更新**：右上角代幣數量立即更新
5. ✅ **配置變更生效**：修改 `mission_watch_ad_limit` 後，限制立即生效

---

## 🐛 如果測試失敗

### 問題 1：仍然獲得 5 代幣（不是 10 代幣）

**檢查**：
1. ✅ 確認 Edge Function 已部署最新版本（包含 `getSystemConfig` 函數）
2. ✅ 確認前端代碼已更新（使用 `useSystemConfigCache`）
3. ✅ 清除 App 緩存或重新構建

### 問題 2：限制仍然是 10 次（不是 30 次）

**檢查**：
1. ✅ 確認 SQL 函數 `add_tokens_from_ad_watch` 已更新
2. ✅ 確認 Edge Function 已部署最新版本
3. ✅ 檢查 Edge Function 日誌，確認配置讀取成功

### 問題 3：修改配置後沒有生效

**解決方案**：
1. 等待幾秒鐘（配置可能需要時間同步）
2. 清除 App 緩存或重新啟動 App
3. 確認配置已正確保存到數據庫

---

## 📝 完整測試檢查清單

- [ ] 配置已設置：`mission_watch_ad_limit` = 30
- [ ] 配置已設置：`mission_watch_ad_reward` = 10
- [ ] SQL 函數 `add_tokens_from_ad_watch` 已更新
- [ ] Edge Function `watch-ad` 已部署
- [ ] 前端代碼已更新（使用 `useSystemConfigCache`）
- [ ] 測試觀看廣告：獲得 10 代幣（不是 5 代幣）
- [ ] 測試限制：達到 30 次後無法再觀看
- [ ] 錯誤訊息顯示正確的限制數量（30 次）
- [ ] 修改配置後限制立即生效

完成所有檢查後，觀看廣告功能就應該完全按照後台配置運行了！

